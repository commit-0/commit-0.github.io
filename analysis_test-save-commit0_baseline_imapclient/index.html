
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.5.37">
    
    
      
        <title>Analysis test save commit0 baseline imapclient - Commit-0</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.8c3ca2c6.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../extra.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#claude-sonnet-35-base-imapclient" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Commit-0" class="md-header__button md-logo" aria-label="Commit-0" data-md-component="logo">
      
  <img src="../logo2.webp" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Commit-0
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Analysis test save commit0 baseline imapclient
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Commit-0" class="md-nav__button md-logo" aria-label="Commit-0" data-md-component="logo">
      
  <img src="../logo2.webp" alt="logo">

    </a>
    Commit-0
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../setupdist/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Commit0
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../agent/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Agent
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../api/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    API
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../analysis/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Leaderboard
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#failed-to-run-pytests-for-test-tests" class="md-nav__link">
    <span class="md-ellipsis">
      Failed to run pytests for test tests
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#patch-diff" class="md-nav__link">
    <span class="md-ellipsis">
      Patch diff
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<p><a href="/analysis_test-save-commit0_baseline">back to Claude Sonnet 3.5 - Base summary</a></p>
<h1 id="claude-sonnet-35-base-imapclient"><strong>Claude Sonnet 3.5 - Base</strong>: imapclient</h1>
<h2 id="failed-to-run-pytests-for-test-tests">Failed to run pytests for test <code>tests</code></h2>
<div class="highlight"><pre><span></span><code>Pytest collection failure.
</code></pre></div>
<h2 id="patch-diff">Patch diff</h2>
<div class="highlight"><pre><span></span><code><span class="gh">diff --git a/imapclient/config.py b/imapclient/config.py</span>
<span class="gh">index f098591..43fc51c 100644</span>
<span class="gd">--- a/imapclient/config.py</span>
<span class="gi">+++ b/imapclient/config.py</span>
<span class="gu">@@ -14,7 +14,25 @@ def parse_config_file(filename: str) -&gt;argparse.Namespace:</span>

<span class="w"> </span>    Used by livetest.py and interact.py
<span class="w"> </span>    &quot;&quot;&quot;
<span class="gd">-    pass</span>
<span class="gi">+    config = configparser.ConfigParser()</span>
<span class="gi">+    config.read(filename)</span>
<span class="gi">+</span>
<span class="gi">+    if &#39;DEFAULT&#39; not in config:</span>
<span class="gi">+        raise ValueError(f&quot;Config file {filename} must have a DEFAULT section&quot;)</span>
<span class="gi">+</span>
<span class="gi">+    ns = argparse.Namespace()</span>
<span class="gi">+    for key, value in config[&#39;DEFAULT&#39;].items():</span>
<span class="gi">+        setattr(ns, key, value)</span>
<span class="gi">+</span>
<span class="gi">+    # Convert certain values to appropriate types</span>
<span class="gi">+    if hasattr(ns, &#39;port&#39;):</span>
<span class="gi">+        ns.port = int(ns.port)</span>
<span class="gi">+    if hasattr(ns, &#39;ssl&#39;):</span>
<span class="gi">+        ns.ssl = config[&#39;DEFAULT&#39;].getboolean(&#39;ssl&#39;)</span>
<span class="gi">+    if hasattr(ns, &#39;timeout&#39;):</span>
<span class="gi">+        ns.timeout = float(ns.timeout)</span>
<span class="gi">+</span>
<span class="gi">+    return ns</span>


<span class="w"> </span>T = TypeVar(&#39;T&#39;)
<span class="gh">diff --git a/imapclient/datetime_util.py b/imapclient/datetime_util.py</span>
<span class="gh">index 57a44c4..6533952 100644</span>
<span class="gd">--- a/imapclient/datetime_util.py</span>
<span class="gi">+++ b/imapclient/datetime_util.py</span>
<span class="gu">@@ -14,7 +14,19 @@ def parse_to_datetime(timestamp: bytes, normalise: bool=True) -&gt;datetime:</span>
<span class="w"> </span>    If normalise is False, then the returned datetime will be
<span class="w"> </span>    unadjusted but will contain timezone information as per the input.
<span class="w"> </span>    &quot;&quot;&quot;
<span class="gd">-    pass</span>
<span class="gi">+    if isinstance(timestamp, bytes):</span>
<span class="gi">+        timestamp = timestamp.decode(&#39;ascii&#39;)</span>
<span class="gi">+    </span>
<span class="gi">+    tt = parsedate_tz(timestamp)</span>
<span class="gi">+    if tt is None:</span>
<span class="gi">+        raise ValueError(&quot;Could not parse datetime string: %r&quot; % timestamp)</span>
<span class="gi">+</span>
<span class="gi">+    tz = tt[-1]</span>
<span class="gi">+    dt = datetime(*tt[:6], tzinfo=FixedOffset(tz) if tz else None)</span>
<span class="gi">+</span>
<span class="gi">+    if normalise:</span>
<span class="gi">+        return dt.astimezone().replace(tzinfo=None)</span>
<span class="gi">+    return dt</span>


<span class="w"> </span>def datetime_to_INTERNALDATE(dt: datetime) -&gt;str:
<span class="gu">@@ -23,7 +35,10 @@ def datetime_to_INTERNALDATE(dt: datetime) -&gt;str:</span>
<span class="w"> </span>    If timezone information is missing the current system
<span class="w"> </span>    timezone is used.
<span class="w"> </span>    &quot;&quot;&quot;
<span class="gd">-    pass</span>
<span class="gi">+    if dt.tzinfo is None:</span>
<span class="gi">+        dt = dt.astimezone()</span>
<span class="gi">+    </span>
<span class="gi">+    return dt.strftime(&quot;%d-%b-%Y %H:%M:%S %z&quot;)</span>


<span class="w"> </span>_rfc822_dotted_time = re.compile(
<span class="gu">@@ -32,4 +47,6 @@ _rfc822_dotted_time = re.compile(</span>

<span class="w"> </span>def format_criteria_date(dt: datetime) -&gt;bytes:
<span class="w"> </span>    &quot;&quot;&quot;Format a date or datetime instance for use in IMAP search criteria.&quot;&quot;&quot;
<span class="gd">-    pass</span>
<span class="gi">+    if isinstance(dt, datetime):</span>
<span class="gi">+        dt = dt.date()</span>
<span class="gi">+    return dt.strftime(&quot;%d-%b-%Y&quot;).encode(&#39;ascii&#39;)</span>
<span class="gh">diff --git a/imapclient/fixed_offset.py b/imapclient/fixed_offset.py</span>
<span class="gh">index b9e7df9..33e7b01 100644</span>
<span class="gd">--- a/imapclient/fixed_offset.py</span>
<span class="gi">+++ b/imapclient/fixed_offset.py</span>
<span class="gu">@@ -23,4 +23,8 @@ class FixedOffset(datetime.tzinfo):</span>
<span class="w"> </span>        &quot;&quot;&quot;Return a FixedOffset instance for the current working timezone and
<span class="w"> </span>        DST conditions.
<span class="w"> </span>        &quot;&quot;&quot;
<span class="gd">-        pass</span>
<span class="gi">+        if time.daylight:</span>
<span class="gi">+            offset = time.altzone</span>
<span class="gi">+        else:</span>
<span class="gi">+            offset = time.timezone</span>
<span class="gi">+        return cls(-offset // 60)</span>
<span class="gh">diff --git a/imapclient/imap_utf7.py b/imapclient/imap_utf7.py</span>
<span class="gh">index 7a795b2..a2876fc 100644</span>
<span class="gd">--- a/imapclient/imap_utf7.py</span>
<span class="gi">+++ b/imapclient/imap_utf7.py</span>
<span class="gu">@@ -1,4 +1,5 @@</span>
<span class="w"> </span>import binascii
<span class="gi">+import base64</span>
<span class="w"> </span>from typing import List, Union


<span class="gu">@@ -8,7 +9,27 @@ def encode(s: Union[str, bytes]) -&gt;bytes:</span>
<span class="w"> </span>    Input is unicode; output is bytes (Python 3) or str (Python 2). If
<span class="w"> </span>    non-unicode input is provided, the input is returned unchanged.
<span class="w"> </span>    &quot;&quot;&quot;
<span class="gd">-    pass</span>
<span class="gi">+    if isinstance(s, bytes):</span>
<span class="gi">+        return s</span>
<span class="gi">+    if not isinstance(s, str):</span>
<span class="gi">+        raise ValueError(&quot;Input must be str or bytes&quot;)</span>
<span class="gi">+    </span>
<span class="gi">+    result = bytearray()</span>
<span class="gi">+    utf7_buffer = bytearray()</span>
<span class="gi">+    </span>
<span class="gi">+    for char in s:</span>
<span class="gi">+        if ord(char) in range(0x20, 0x7f) and char != &#39;&amp;&#39;:</span>
<span class="gi">+            if utf7_buffer:</span>
<span class="gi">+                result.extend(b&#39;&amp;&#39; + base64.b64encode(utf7_buffer).rstrip(b&#39;=&#39;).replace(b&#39;/&#39;, b&#39;,&#39;) + b&#39;-&#39;)</span>
<span class="gi">+                utf7_buffer = bytearray()</span>
<span class="gi">+            result.extend(char.encode(&#39;ascii&#39;))</span>
<span class="gi">+        else:</span>
<span class="gi">+            utf7_buffer.extend(char.encode(&#39;utf-16be&#39;))</span>
<span class="gi">+    </span>
<span class="gi">+    if utf7_buffer:</span>
<span class="gi">+        result.extend(b&#39;&amp;&#39; + base64.b64encode(utf7_buffer).rstrip(b&#39;=&#39;).replace(b&#39;/&#39;, b&#39;,&#39;) + b&#39;-&#39;)</span>
<span class="gi">+    </span>
<span class="gi">+    return bytes(result)</span>


<span class="w"> </span>AMPERSAND_ORD = ord(&#39;&amp;&#39;)
<span class="gu">@@ -22,4 +43,33 @@ def decode(s: Union[bytes, str]) -&gt;str:</span>
<span class="w"> </span>    unicode. If non-bytes/str input is provided, the input is returned
<span class="w"> </span>    unchanged.
<span class="w"> </span>    &quot;&quot;&quot;
<span class="gd">-    pass</span>
<span class="gi">+    if isinstance(s, str):</span>
<span class="gi">+        s = s.encode(&#39;ascii&#39;)</span>
<span class="gi">+    if not isinstance(s, bytes):</span>
<span class="gi">+        raise ValueError(&quot;Input must be str or bytes&quot;)</span>
<span class="gi">+    </span>
<span class="gi">+    result = []</span>
<span class="gi">+    utf7_buffer = bytearray()</span>
<span class="gi">+    in_utf7 = False</span>
<span class="gi">+    </span>
<span class="gi">+    for byte in s:</span>
<span class="gi">+        if in_utf7:</span>
<span class="gi">+            if byte == DASH_ORD:</span>
<span class="gi">+                if utf7_buffer:</span>
<span class="gi">+                    utf16_bytes = base64.b64decode(utf7_buffer.replace(b&#39;,&#39;, b&#39;/&#39;) + b&#39;===&#39;)</span>
<span class="gi">+                    result.append(utf16_bytes.decode(&#39;utf-16be&#39;))</span>
<span class="gi">+                in_utf7 = False</span>
<span class="gi">+                utf7_buffer = bytearray()</span>
<span class="gi">+            elif byte in (AMPERSAND_ORD, DASH_ORD):</span>
<span class="gi">+                utf7_buffer.append(byte)</span>
<span class="gi">+            else:</span>
<span class="gi">+                utf7_buffer.append(byte)</span>
<span class="gi">+        elif byte == AMPERSAND_ORD:</span>
<span class="gi">+            in_utf7 = True</span>
<span class="gi">+        else:</span>
<span class="gi">+            result.append(chr(byte))</span>
<span class="gi">+    </span>
<span class="gi">+    if in_utf7:</span>
<span class="gi">+        raise ValueError(&quot;Invalid IMAP UTF-7 encoding&quot;)</span>
<span class="gi">+    </span>
<span class="gi">+    return &#39;&#39;.join(result)</span>
<span class="gh">diff --git a/imapclient/imapclient.py b/imapclient/imapclient.py</span>
<span class="gh">index 1b399f1..c2fd28c 100644</span>
<span class="gd">--- a/imapclient/imapclient.py</span>
<span class="gi">+++ b/imapclient/imapclient.py</span>
<span class="gu">@@ -239,7 +239,7 @@ class IMAPClient:</span>
<span class="w"> </span>           This includes reading from and writing to the socket,
<span class="w"> </span>           as they are likely to break internal bookkeeping of messages.
<span class="w"> </span>        &quot;&quot;&quot;
<span class="gd">-        pass</span>
<span class="gi">+        return self._imap.sock</span>

<span class="w"> </span>    @require_capability(&#39;STARTTLS&#39;)
<span class="w"> </span>    def starttls(self, ssl_context=None):
<span class="gu">@@ -259,13 +259,34 @@ class IMAPClient:</span>
<span class="w"> </span>        Raises :py:exc:`AbortError` if the server does not support STARTTLS
<span class="w"> </span>        or an SSL connection is already established.
<span class="w"> </span>        &quot;&quot;&quot;
<span class="gd">-        pass</span>
<span class="gi">+        if self._starttls_done:</span>
<span class="gi">+            raise self.AbortError(&#39;STARTTLS has already been called&#39;)</span>
<span class="gi">+        </span>
<span class="gi">+        if ssl_context is None:</span>
<span class="gi">+            ssl_context = ssl_lib.create_default_context()</span>
<span class="gi">+        </span>
<span class="gi">+        typ, data = self._imap._simple_command(&#39;STARTTLS&#39;)</span>
<span class="gi">+        self._checkok(&#39;starttls&#39;, typ, data)</span>
<span class="gi">+        </span>
<span class="gi">+        self._imap.sock = ssl_context.wrap_socket(self._imap.sock,</span>
<span class="gi">+                                                  server_hostname=self.host)</span>
<span class="gi">+        self._imap.file = self._imap.sock.makefile(&#39;rb&#39;)</span>
<span class="gi">+        self._starttls_done = True</span>
<span class="gi">+        </span>
<span class="gi">+        # Reissue CAPABILITY command after STARTTLS</span>
<span class="gi">+        self._cached_capabilities = None</span>
<span class="gi">+        self.capabilities()</span>

<span class="w"> </span>    def login(self, username: str, password: str):
<span class="w"> </span>        &quot;&quot;&quot;Login using *username* and *password*, returning the
<span class="w"> </span>        server response.
<span class="w"> </span>        &quot;&quot;&quot;
<span class="gd">-        pass</span>
<span class="gi">+        try:</span>
<span class="gi">+            typ, data = self._imap.login(username, password)</span>
<span class="gi">+            self._checkok(&#39;login&#39;, typ, data)</span>
<span class="gi">+            return data[0].decode()</span>
<span class="gi">+        except imaplib.IMAP4.error as e:</span>
<span class="gi">+            raise self.Error(f&#39;Login failed: {str(e)}&#39;)</span>

<span class="w"> </span>    def oauth2_login(self, user: str, access_token: str, mech: str=
<span class="w"> </span>        &#39;XOAUTH2&#39;, vendor: Optional[str]=None):
<span class="gu">@@ -274,7 +295,17 @@ class IMAPClient:</span>
<span class="w"> </span>        Gmail and Yahoo both support the &#39;XOAUTH2&#39; mechanism, but Yahoo requires
<span class="w"> </span>        the &#39;vendor&#39; portion in the payload.
<span class="w"> </span>        &quot;&quot;&quot;
<span class="gd">-        pass</span>
<span class="gi">+        auth_string = f&#39;user={user}\1auth=Bearer {access_token}\1&#39;</span>
<span class="gi">+        if vendor:</span>
<span class="gi">+            auth_string += f&#39;\1vendor={vendor}&#39;</span>
<span class="gi">+        auth_string += &#39;\1\1&#39;</span>
<span class="gi">+</span>
<span class="gi">+        try:</span>
<span class="gi">+            typ, data = self._imap.authenticate(mech, lambda x: auth_string)</span>
<span class="gi">+            self._checkok(&#39;oauth2_login&#39;, typ, data)</span>
<span class="gi">+            return data[0].decode()</span>
<span class="gi">+        except imaplib.IMAP4.error as e:</span>
<span class="gi">+            raise self.Error(f&#39;OAuth2 login failed: {str(e)}&#39;)</span>

<span class="w"> </span>    def oauthbearer_login(self, identity, access_token):
<span class="w"> </span>        &quot;&quot;&quot;Authenticate using the OAUTHBEARER method.
<span class="gh">diff --git a/imapclient/response_parser.py b/imapclient/response_parser.py</span>
<span class="gh">index f632411..e8b489d 100644</span>
<span class="gd">--- a/imapclient/response_parser.py</span>
<span class="gi">+++ b/imapclient/response_parser.py</span>
<span class="gu">@@ -22,7 +22,19 @@ def parse_response(data: List[bytes]) -&gt;Tuple[_Atom, ...]:</span>

<span class="w"> </span>    Returns nested tuples of appropriately typed objects.
<span class="w"> </span>    &quot;&quot;&quot;
<span class="gd">-    pass</span>
<span class="gi">+    lexer = TokenSource(data)</span>
<span class="gi">+    return tuple(_parse_tokens(lexer))</span>
<span class="gi">+</span>
<span class="gi">+def _parse_tokens(lexer: TokenSource) -&gt;Iterator[_Atom]:</span>
<span class="gi">+    for token in lexer:</span>
<span class="gi">+        if token == b&#39;(&#39;:</span>
<span class="gi">+            yield tuple(_parse_tokens(lexer))</span>
<span class="gi">+        elif token == b&#39;)&#39;:</span>
<span class="gi">+            return</span>
<span class="gi">+        elif isinstance(token, bytes):</span>
<span class="gi">+            yield token.decode(&#39;ascii&#39;)</span>
<span class="gi">+        else:</span>
<span class="gi">+            yield token</span>


<span class="w"> </span>_msg_id_pattern = re.compile(&#39;(\\d+(?: +\\d+)*)&#39;)
<span class="gu">@@ -39,7 +51,17 @@ def parse_message_list(data: List[Union[bytes, str]]) -&gt;SearchIds:</span>
<span class="w"> </span>    attribute which contains the MODSEQ response (if returned by the
<span class="w"> </span>    server).
<span class="w"> </span>    &quot;&quot;&quot;
<span class="gd">-    pass</span>
<span class="gi">+    data = [item.decode(&#39;ascii&#39;) if isinstance(item, bytes) else item for item in data]</span>
<span class="gi">+    data = &#39; &#39;.join(data)</span>
<span class="gi">+    </span>
<span class="gi">+    modseq = None</span>
<span class="gi">+    if &#39;MODSEQ&#39; in data:</span>
<span class="gi">+        modseq_index = data.index(&#39;MODSEQ&#39;)</span>
<span class="gi">+        modseq = int(data[modseq_index + 1])</span>
<span class="gi">+        data = data[:modseq_index]</span>
<span class="gi">+    </span>
<span class="gi">+    ids = [int(num) for num in _msg_id_pattern.findall(data)]</span>
<span class="gi">+    return SearchIds(ids, modseq)</span>


<span class="w"> </span>_ParseFetchResponseInnerDict = Dict[bytes, Optional[Union[datetime.datetime,
<span class="gu">@@ -53,4 +75,62 @@ def parse_fetch_response(text: List[bytes], normalise_times: bool=True,</span>
<span class="w"> </span>    Returns a dictionary, keyed by message ID. Each value a dictionary
<span class="w"> </span>    keyed by FETCH field type (eg.&quot;RFC822&quot;).
<span class="w"> </span>    &quot;&quot;&quot;
<span class="gd">-    pass</span>
<span class="gi">+    response = defaultdict(dict)</span>
<span class="gi">+    lexer = TokenSource(text)</span>
<span class="gi">+</span>
<span class="gi">+    while True:</span>
<span class="gi">+        try:</span>
<span class="gi">+            msg_id = int(next(lexer))</span>
<span class="gi">+        except StopIteration:</span>
<span class="gi">+            break</span>
<span class="gi">+</span>
<span class="gi">+        if next(lexer) != b&#39;(&#39;:</span>
<span class="gi">+            raise ProtocolError(&#39;Expected &quot;(&quot; in FETCH response&#39;)</span>
<span class="gi">+</span>
<span class="gi">+        for key, value in _parse_fetch_pairs(lexer, normalise_times):</span>
<span class="gi">+            if uid_is_key and key == b&#39;UID&#39;:</span>
<span class="gi">+                msg_id = value</span>
<span class="gi">+            else:</span>
<span class="gi">+                response[msg_id][key] = value</span>
<span class="gi">+</span>
<span class="gi">+        if next(lexer) != b&#39;)&#39;:</span>
<span class="gi">+            raise ProtocolError(&#39;Expected &quot;)&quot; in FETCH response&#39;)</span>
<span class="gi">+</span>
<span class="gi">+    return response</span>
<span class="gi">+</span>
<span class="gi">+def _parse_fetch_pairs(lexer: TokenSource, normalise_times: bool) -&gt;Iterator[Tuple[bytes, Union[datetime.datetime, int, BodyData, Envelope, _Atom]]]:</span>
<span class="gi">+    while True:</span>
<span class="gi">+        try:</span>
<span class="gi">+            key = next(lexer)</span>
<span class="gi">+        except StopIteration:</span>
<span class="gi">+            return</span>
<span class="gi">+</span>
<span class="gi">+        if key == b&#39;)&#39;:</span>
<span class="gi">+            lexer.push(key)</span>
<span class="gi">+            return</span>
<span class="gi">+</span>
<span class="gi">+        value = _parse_fetch_value(lexer, key, normalise_times)</span>
<span class="gi">+        yield key, value</span>
<span class="gi">+</span>
<span class="gi">+def _parse_fetch_value(lexer: TokenSource, key: bytes, normalise_times: bool) -&gt;Union[datetime.datetime, int, BodyData, Envelope, _Atom]:</span>
<span class="gi">+    if key in (b&#39;INTERNALDATE&#39;, b&#39;ENVELOPE&#39;):</span>
<span class="gi">+        value = next(lexer)</span>
<span class="gi">+        if key == b&#39;INTERNALDATE&#39; and normalise_times:</span>
<span class="gi">+            return parse_to_datetime(value.decode(&#39;ascii&#39;))</span>
<span class="gi">+        elif key == b&#39;ENVELOPE&#39;:</span>
<span class="gi">+            return Envelope(*parse_response(value))</span>
<span class="gi">+    elif key == b&#39;BODY&#39; and next(lexer) == b&#39;[&#39;:</span>
<span class="gi">+        section = b&#39;&#39;</span>
<span class="gi">+        while True:</span>
<span class="gi">+            token = next(lexer)</span>
<span class="gi">+            if token == b&#39;]&#39;:</span>
<span class="gi">+                break</span>
<span class="gi">+            section += token</span>
<span class="gi">+        next(lexer)  # Consume the space</span>
<span class="gi">+        value = next(lexer)</span>
<span class="gi">+        return BodyData(section, value)</span>
<span class="gi">+    else:</span>
<span class="gi">+        value = next(lexer)</span>
<span class="gi">+        if isinstance(value, int):</span>
<span class="gi">+            return value</span>
<span class="gi">+        return value.decode(&#39;ascii&#39;)</span>
</code></pre></div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.6ce7567c.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.d6f25eb3.min.js"></script>
      
        <script src="https://unpkg.com/tablesort@5.3.0/dist/tablesort.min.js"></script>
      
        <script src="../javascripts/tablesort.js"></script>
      
        <script src="../javascripts/tablesort.number.js"></script>
      
    
  </body>
</html>