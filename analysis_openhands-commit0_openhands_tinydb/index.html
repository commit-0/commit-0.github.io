
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.5.37">
    
    
      
        <title>Analysis openhands commit0 openhands tinydb - Commit-0</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.8c3ca2c6.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../extra.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#openhands-tinydb" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Commit-0" class="md-header__button md-logo" aria-label="Commit-0" data-md-component="logo">
      
  <img src="../logo2.webp" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Commit-0
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Analysis openhands commit0 openhands tinydb
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Commit-0" class="md-nav__button md-logo" aria-label="Commit-0" data-md-component="logo">
      
  <img src="../logo2.webp" alt="logo">

    </a>
    Commit-0
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../setupdist/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Commit0
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../agent/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Agent
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../api/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    API
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../analysis/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Leaderboard
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#pytest-summary-for-test-tests" class="md-nav__link">
    <span class="md-ellipsis">
      Pytest Summary for test tests
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#failed-pytests" class="md-nav__link">
    <span class="md-ellipsis">
      Failed pytests:
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Failed pytests:">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#test_storagespytest_json_kwargs" class="md-nav__link">
    <span class="md-ellipsis">
      test_storages.py::test_json_kwargs
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#test_storagespytest_encoding" class="md-nav__link">
    <span class="md-ellipsis">
      test_storages.py::test_encoding
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#test_tablespytest_query_cache_with_mutable_callablememory" class="md-nav__link">
    <span class="md-ellipsis">
      test_tables.py::test_query_cache_with_mutable_callable[memory]
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#test_tablespytest_query_cache_with_mutable_callablejson" class="md-nav__link">
    <span class="md-ellipsis">
      test_tables.py::test_query_cache_with_mutable_callable[json]
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#test_tinydbpytest_insert_idsmemory" class="md-nav__link">
    <span class="md-ellipsis">
      test_tinydb.py::test_insert_ids[memory]
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#test_tinydbpytest_insert_idsjson" class="md-nav__link">
    <span class="md-ellipsis">
      test_tinydb.py::test_insert_ids[json]
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#test_tinydbpytest_insert_with_doc_idmemory" class="md-nav__link">
    <span class="md-ellipsis">
      test_tinydb.py::test_insert_with_doc_id[memory]
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#test_tinydbpytest_insert_with_doc_idjson" class="md-nav__link">
    <span class="md-ellipsis">
      test_tinydb.py::test_insert_with_doc_id[json]
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#test_tinydbpytest_insert_with_duplicate_doc_idmemory" class="md-nav__link">
    <span class="md-ellipsis">
      test_tinydb.py::test_insert_with_duplicate_doc_id[memory]
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#test_tinydbpytest_insert_with_duplicate_doc_idjson" class="md-nav__link">
    <span class="md-ellipsis">
      test_tinydb.py::test_insert_with_duplicate_doc_id[json]
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#test_tinydbpytest_insert_multiple_with_idsmemory" class="md-nav__link">
    <span class="md-ellipsis">
      test_tinydb.py::test_insert_multiple_with_ids[memory]
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#test_tinydbpytest_insert_multiple_with_idsjson" class="md-nav__link">
    <span class="md-ellipsis">
      test_tinydb.py::test_insert_multiple_with_ids[json]
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#test_tinydbpytest_insert_multiple_with_doc_idsjson" class="md-nav__link">
    <span class="md-ellipsis">
      test_tinydb.py::test_insert_multiple_with_doc_ids[json]
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#test_tinydbpytest_custom_mapping_type_with_json" class="md-nav__link">
    <span class="md-ellipsis">
      test_tinydb.py::test_custom_mapping_type_with_json
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#test_tinydbpytest_remove_idsjson" class="md-nav__link">
    <span class="md-ellipsis">
      test_tinydb.py::test_remove_ids[json]
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#test_tinydbpytest_remove_returns_idsjson" class="md-nav__link">
    <span class="md-ellipsis">
      test_tinydb.py::test_remove_returns_ids[json]
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#test_tinydbpytest_update_returns_idsmemory" class="md-nav__link">
    <span class="md-ellipsis">
      test_tinydb.py::test_update_returns_ids[memory]
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#test_tinydbpytest_update_returns_idsjson" class="md-nav__link">
    <span class="md-ellipsis">
      test_tinydb.py::test_update_returns_ids[json]
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#test_tinydbpytest_update_idsjson" class="md-nav__link">
    <span class="md-ellipsis">
      test_tinydb.py::test_update_ids[json]
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#test_tinydbpytest_upsert_by_idmemory" class="md-nav__link">
    <span class="md-ellipsis">
      test_tinydb.py::test_upsert_by_id[memory]
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#test_tinydbpytest_upsert_by_idjson" class="md-nav__link">
    <span class="md-ellipsis">
      test_tinydb.py::test_upsert_by_id[json]
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#test_tinydbpytest_get_idsjson" class="md-nav__link">
    <span class="md-ellipsis">
      test_tinydb.py::test_get_ids[json]
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#test_tinydbpytest_get_multiple_idsjson" class="md-nav__link">
    <span class="md-ellipsis">
      test_tinydb.py::test_get_multiple_ids[json]
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#test_tinydbpytest_contains_idsjson" class="md-nav__link">
    <span class="md-ellipsis">
      test_tinydb.py::test_contains_ids[json]
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#test_tinydbpytest_doc_ids_json" class="md-nav__link">
    <span class="md-ellipsis">
      test_tinydb.py::test_doc_ids_json
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#test_tinydbpytest_insert_invalid_dict" class="md-nav__link">
    <span class="md-ellipsis">
      test_tinydb.py::test_insert_invalid_dict
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#test_utilspytest_freeze" class="md-nav__link">
    <span class="md-ellipsis">
      test_utils.py::test_freeze
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#patch-diff" class="md-nav__link">
    <span class="md-ellipsis">
      Patch diff
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<p><a href="/analysis_openhands-commit0_openhands">back to OpenHands summary</a></p>
<h1 id="openhands-tinydb"><strong>OpenHands</strong>: tinydb</h1>
<h2 id="pytest-summary-for-test-tests">Pytest Summary for test <code>tests</code></h2>
<table>
<thead>
<tr>
<th style="text-align: left;">status</th>
<th style="text-align: center;">count</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">passed</td>
<td style="text-align: center;">174</td>
</tr>
<tr>
<td style="text-align: left;">failed</td>
<td style="text-align: center;">27</td>
</tr>
<tr>
<td style="text-align: left;">total</td>
<td style="text-align: center;">201</td>
</tr>
<tr>
<td style="text-align: left;">collected</td>
<td style="text-align: center;">201</td>
</tr>
</tbody>
</table>
<h2 id="failed-pytests">Failed pytests:</h2>
<h3 id="test_storagespytest_json_kwargs">test_storages.py::test_json_kwargs</h3>
<details><summary> <pre>test_storages.py::test_json_kwargs</pre></summary><pre>
tmpdir = local('/tmp/pytest-of-root/pytest-0/test_json_kwargs0')

    def test_json_kwargs(tmpdir):
        db_file = tmpdir.join('test.db')
        db = TinyDB(str(db_file), sort_keys=True, indent=4, separators=(',', ': '))

        # Write contents
        db.insert({'b': 1})
>       db.insert({'a': 1})

tests/test_storages.py:37: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
tinydb/table.py:115: in insert
    self._update_table(updater)
tinydb/table.py:455: in _update_table
    self._storage.write(raw_data)
tinydb/storages.py:110: in write
    json.dump(data, self._handle, **self.kwargs)
/usr/lib/python3.10/json/__init__.py:179: in dump
    for chunk in iterable:
/usr/lib/python3.10/json/encoder.py:431: in _iterencode
    yield from _iterencode_dict(o, _current_indent_level)
/usr/lib/python3.10/json/encoder.py:405: in _iterencode_dict
    yield from chunks
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

dct = {'1': {'b': 1}, 2: {'a': 1}}, _current_indent_level = 2

    def _iterencode_dict(dct, _current_indent_level):
        if not dct:
            yield '{}'
            return
        if markers is not None:
            markerid = id(dct)
            if markerid in markers:
                raise ValueError("Circular reference detected")
            markers[markerid] = dct
        yield '{'
        if _indent is not None:
            _current_indent_level += 1
            newline_indent = '\n' + _indent * _current_indent_level
            item_separator = _item_separator + newline_indent
            yield newline_indent
        else:
            newline_indent = None
            item_separator = _item_separator
        first = True
        if _sort_keys:
>           items = sorted(dct.items())
E           TypeError: '<' not supported between instances of 'int' and 'str'

/usr/lib/python3.10/json/encoder.py:353: TypeError
</pre>
</details>
<h3 id="test_storagespytest_encoding">test_storages.py::test_encoding</h3>
<details><summary> <pre>test_storages.py::test_encoding</pre></summary><pre>
tmpdir = local('/tmp/pytest-of-root/pytest-0/test_encoding0')

    def test_encoding(tmpdir):
        japanese_doc = {"Test": u"こんにちは世界"}

        path = str(tmpdir.join('test.db'))
        # cp936 is used for japanese encodings
        jap_storage = JSONStorage(path, encoding="cp936")
        jap_storage.write(japanese_doc)

        try:
            exception = json.decoder.JSONDecodeError
        except AttributeError:
            exception = ValueError

>       with pytest.raises(exception):
E       Failed: DID NOT RAISE <class 'json.decoder.JSONDecodeError'>

tests/test_storages.py:275: Failed
</pre>
</details>
<h3 id="test_tablespytest_query_cache_with_mutable_callablememory">test_tables.py::test_query_cache_with_mutable_callable[memory]</h3>
<details><summary> <pre>test_tables.py::test_query_cache_with_mutable_callable[memory]</pre></summary><pre>
db = <TinyDB tables=['_default', 'table'], tables_count=2, default_table_documents_count=3, all_tables_documents_count=['_default=3', 'table=1']>

    def test_query_cache_with_mutable_callable(db):
        table = db.table('table')
        table.insert({'val': 5})

        mutable = 5
        increase = lambda x: x + mutable

        assert where('val').is_cacheable()
>       assert not where('val').map(increase).is_cacheable()
E       AssertionError: assert not True
E        +  where True = is_cacheable()
E        +    where is_cacheable = Query().is_cacheable
E        +      where Query() = map(<function test_query_cache_with_mutable_callable.<locals>.<lambda> at 0x7f1aef6baa70>)
E        +        where map = Query().map
E        +          where Query() = where('val')

tests/test_tables.py:85: AssertionError
</pre>
</details>
<h3 id="test_tablespytest_query_cache_with_mutable_callablejson">test_tables.py::test_query_cache_with_mutable_callable[json]</h3>
<details><summary> <pre>test_tables.py::test_query_cache_with_mutable_callable[json]</pre></summary><pre>
db = <TinyDB tables=['_default', 'table'], tables_count=2, default_table_documents_count=3, all_tables_documents_count=['_default=3', 'table=1']>

    def test_query_cache_with_mutable_callable(db):
        table = db.table('table')
        table.insert({'val': 5})

        mutable = 5
        increase = lambda x: x + mutable

        assert where('val').is_cacheable()
>       assert not where('val').map(increase).is_cacheable()
E       AssertionError: assert not True
E        +  where True = is_cacheable()
E        +    where is_cacheable = Query().is_cacheable
E        +      where Query() = map(<function test_query_cache_with_mutable_callable.<locals>.<lambda> at 0x7f1aef6bad40>)
E        +        where map = Query().map
E        +          where Query() = where('val')

tests/test_tables.py:85: AssertionError
</pre>
</details>
<h3 id="test_tinydbpytest_insert_idsmemory">test_tinydb.py::test_insert_ids[memory]</h3>
<details><summary> <pre>test_tinydb.py::test_insert_ids[memory]</pre></summary><pre>
db = <TinyDB tables=['_default'], tables_count=1, default_table_documents_count=1, all_tables_documents_count=['_default=1']>

    def test_insert_ids(db: TinyDB):
        db.drop_tables()
>       assert db.insert({'int': 1, 'char': 'a'}) == 1
E       AssertionError: assert 4 == 1
E        +  where 4 = insert({'char': 'a', 'int': 1})
E        +    where insert = <TinyDB tables=['_default'], tables_count=1, default_table_documents_count=1, all_tables_documents_count=['_default=1']>.insert

tests/test_tinydb.py:48: AssertionError
</pre>
</details>
<h3 id="test_tinydbpytest_insert_idsjson">test_tinydb.py::test_insert_ids[json]</h3>
<details><summary> <pre>test_tinydb.py::test_insert_ids[json]</pre></summary><pre>
db = <TinyDB tables=['_default'], tables_count=1, default_table_documents_count=1, all_tables_documents_count=['_default=1']>

    def test_insert_ids(db: TinyDB):
        db.drop_tables()
>       assert db.insert({'int': 1, 'char': 'a'}) == 1
E       AssertionError: assert 4 == 1
E        +  where 4 = insert({'char': 'a', 'int': 1})
E        +    where insert = <TinyDB tables=['_default'], tables_count=1, default_table_documents_count=1, all_tables_documents_count=['_default=1']>.insert

tests/test_tinydb.py:48: AssertionError
</pre>
</details>
<h3 id="test_tinydbpytest_insert_with_doc_idmemory">test_tinydb.py::test_insert_with_doc_id[memory]</h3>
<details><summary> <pre>test_tinydb.py::test_insert_with_doc_id[memory]</pre></summary><pre>
db = <TinyDB tables=['_default'], tables_count=1, default_table_documents_count=1, all_tables_documents_count=['_default=1']>

    def test_insert_with_doc_id(db: TinyDB):
        db.drop_tables()
>       assert db.insert({'int': 1, 'char': 'a'}) == 1
E       AssertionError: assert 4 == 1
E        +  where 4 = insert({'char': 'a', 'int': 1})
E        +    where insert = <TinyDB tables=['_default'], tables_count=1, default_table_documents_count=1, all_tables_documents_count=['_default=1']>.insert

tests/test_tinydb.py:54: AssertionError
</pre>
</details>
<h3 id="test_tinydbpytest_insert_with_doc_idjson">test_tinydb.py::test_insert_with_doc_id[json]</h3>
<details><summary> <pre>test_tinydb.py::test_insert_with_doc_id[json]</pre></summary><pre>
db = <TinyDB tables=['_default'], tables_count=1, default_table_documents_count=1, all_tables_documents_count=['_default=1']>

    def test_insert_with_doc_id(db: TinyDB):
        db.drop_tables()
>       assert db.insert({'int': 1, 'char': 'a'}) == 1
E       AssertionError: assert 4 == 1
E        +  where 4 = insert({'char': 'a', 'int': 1})
E        +    where insert = <TinyDB tables=['_default'], tables_count=1, default_table_documents_count=1, all_tables_documents_count=['_default=1']>.insert

tests/test_tinydb.py:54: AssertionError
</pre>
</details>
<h3 id="test_tinydbpytest_insert_with_duplicate_doc_idmemory">test_tinydb.py::test_insert_with_duplicate_doc_id[memory]</h3>
<details><summary> <pre>test_tinydb.py::test_insert_with_duplicate_doc_id[memory]</pre></summary><pre>
db = <TinyDB tables=['_default'], tables_count=1, default_table_documents_count=1, all_tables_documents_count=['_default=1']>

    def test_insert_with_duplicate_doc_id(db: TinyDB):
        db.drop_tables()
>       assert db.insert({'int': 1, 'char': 'a'}) == 1
E       AssertionError: assert 4 == 1
E        +  where 4 = insert({'char': 'a', 'int': 1})
E        +    where insert = <TinyDB tables=['_default'], tables_count=1, default_table_documents_count=1, all_tables_documents_count=['_default=1']>.insert

tests/test_tinydb.py:62: AssertionError
</pre>
</details>
<h3 id="test_tinydbpytest_insert_with_duplicate_doc_idjson">test_tinydb.py::test_insert_with_duplicate_doc_id[json]</h3>
<details><summary> <pre>test_tinydb.py::test_insert_with_duplicate_doc_id[json]</pre></summary><pre>
db = <TinyDB tables=['_default'], tables_count=1, default_table_documents_count=1, all_tables_documents_count=['_default=1']>

    def test_insert_with_duplicate_doc_id(db: TinyDB):
        db.drop_tables()
>       assert db.insert({'int': 1, 'char': 'a'}) == 1
E       AssertionError: assert 4 == 1
E        +  where 4 = insert({'char': 'a', 'int': 1})
E        +    where insert = <TinyDB tables=['_default'], tables_count=1, default_table_documents_count=1, all_tables_documents_count=['_default=1']>.insert

tests/test_tinydb.py:62: AssertionError
</pre>
</details>
<h3 id="test_tinydbpytest_insert_multiple_with_idsmemory">test_tinydb.py::test_insert_multiple_with_ids[memory]</h3>
<details><summary> <pre>test_tinydb.py::test_insert_multiple_with_ids[memory]</pre></summary><pre>
db = <TinyDB tables=['_default'], tables_count=1, default_table_documents_count=3, all_tables_documents_count=['_default=3']>

    def test_insert_multiple_with_ids(db: TinyDB):
        db.drop_tables()

        # Insert multiple from list
>       assert db.insert_multiple([{'int': 1, 'char': 'a'},
                                   {'int': 1, 'char': 'b'},
                                   {'int': 1, 'char': 'c'}]) == [1, 2, 3]
E       AssertionError: assert [4, 5, 6] == [1, 2, 3]
E         
E         At index 0 diff: 4 != 1
E         
E         Full diff:
E           [
E         -     1,
E         ?     ^...
E         
E         ...Full output truncated (11 lines hidden), use '-vv' to show

tests/test_tinydb.py:106: AssertionError
</pre>
</details>
<h3 id="test_tinydbpytest_insert_multiple_with_idsjson">test_tinydb.py::test_insert_multiple_with_ids[json]</h3>
<details><summary> <pre>test_tinydb.py::test_insert_multiple_with_ids[json]</pre></summary><pre>
db = <TinyDB tables=['_default'], tables_count=1, default_table_documents_count=3, all_tables_documents_count=['_default=3']>

    def test_insert_multiple_with_ids(db: TinyDB):
        db.drop_tables()

        # Insert multiple from list
>       assert db.insert_multiple([{'int': 1, 'char': 'a'},
                                   {'int': 1, 'char': 'b'},
                                   {'int': 1, 'char': 'c'}]) == [1, 2, 3]
E       AssertionError: assert [4, 5, 6] == [1, 2, 3]
E         
E         At index 0 diff: 4 != 1
E         
E         Full diff:
E           [
E         -     1,
E         ?     ^...
E         
E         ...Full output truncated (11 lines hidden), use '-vv' to show

tests/test_tinydb.py:106: AssertionError
</pre>
</details>
<h3 id="test_tinydbpytest_insert_multiple_with_doc_idsjson">test_tinydb.py::test_insert_multiple_with_doc_ids[json]</h3>
<details><summary> <pre>test_tinydb.py::test_insert_multiple_with_doc_ids[json]</pre></summary><pre>
db = <TinyDB tables=['_default'], tables_count=1, default_table_documents_count=2, all_tables_documents_count=['_default=2']>

    def test_insert_multiple_with_doc_ids(db: TinyDB):
        db.drop_tables()

        assert db.insert_multiple([
            Document({'int': 1, 'char': 'a'}, 12),
            Document({'int': 1, 'char': 'b'}, 77)
        ]) == [12, 77]
>       assert db.get(doc_id=12) == {'int': 1, 'char': 'a'}
E       AssertionError: assert None == {'char': 'a', 'int': 1}
E        +  where None = get(doc_id=12)
E        +    where get = <TinyDB tables=['_default'], tables_count=1, default_table_documents_count=2, all_tables_documents_count=['_default=2']>.get

tests/test_tinydb.py:118: AssertionError
</pre>
</details>
<h3 id="test_tinydbpytest_custom_mapping_type_with_json">test_tinydb.py::test_custom_mapping_type_with_json</h3>
<details><summary> <pre>test_tinydb.py::test_custom_mapping_type_with_json</pre></summary><pre>
tmpdir = local('/tmp/pytest-of-root/pytest-0/test_custom_mapping_type_with_0')

    def test_custom_mapping_type_with_json(tmpdir):
        class CustomDocument(Mapping):
            def __init__(self, data):
                self.data = data

            def __getitem__(self, key):
                return self.data[key]

            def __iter__(self):
                return iter(self.data)

            def __len__(self):
                return len(self.data)

        # Insert
        db = TinyDB(str(tmpdir.join('test.db')))
        db.drop_tables()
        db.insert(CustomDocument({'int': 1, 'char': 'a'}))
        assert db.count(where('int') == 1) == 1

        # Insert multiple
        db.insert_multiple([
            CustomDocument({'int': 2, 'char': 'a'}),
            CustomDocument({'int': 3, 'char': 'a'})
        ])
        assert db.count(where('int') == 1) == 1
        assert db.count(where('int') == 2) == 1
        assert db.count(where('int') == 3) == 1

        # Write back
        doc_id = db.get(where('int') == 3).doc_id
        db.update(CustomDocument({'int': 4, 'char': 'a'}), doc_ids=[doc_id])
>       assert db.count(where('int') == 3) == 0
E       AssertionError: assert 1 == 0
E        +  where 1 = count(Query() == 3)
E        +    where count = <TinyDB tables=['_default'], tables_count=1, default_table_documents_count=3, all_tables_documents_count=['_default=3']>.count
E        +    and   Query() = where('int')

tests/test_tinydb.py:182: AssertionError
</pre>
</details>
<h3 id="test_tinydbpytest_remove_idsjson">test_tinydb.py::test_remove_ids[json]</h3>
<details><summary> <pre>test_tinydb.py::test_remove_ids[json]</pre></summary><pre>
db = <TinyDB tables=['_default'], tables_count=1, default_table_documents_count=3, all_tables_documents_count=['_default=3']>

    def test_remove_ids(db: TinyDB):
        db.remove(doc_ids=[1, 2])

>       assert len(db) == 1
E       AssertionError: assert 3 == 1
E        +  where 3 = len(<TinyDB tables=['_default'], tables_count=1, default_table_documents_count=3, all_tables_documents_count=['_default=3']>)

tests/test_tinydb.py:207: AssertionError
</pre>
</details>
<h3 id="test_tinydbpytest_remove_returns_idsjson">test_tinydb.py::test_remove_returns_ids[json]</h3>
<details><summary> <pre>test_tinydb.py::test_remove_returns_ids[json]</pre></summary><pre>
db = <TinyDB tables=['_default'], tables_count=1, default_table_documents_count=2, all_tables_documents_count=['_default=2']>

    def test_remove_returns_ids(db: TinyDB):
>       assert db.remove(where('char') == 'b') == [2]
E       AssertionError: assert ['2'] == [2]
E         
E         At index 0 diff: '2' != 2
E         
E         Full diff:
E           [
E         -     2,
E         +     '2',
E         ?     + +
E           ]

tests/test_tinydb.py:211: AssertionError
</pre>
</details>
<h3 id="test_tinydbpytest_update_returns_idsmemory">test_tinydb.py::test_update_returns_ids[memory]</h3>
<details><summary> <pre>test_tinydb.py::test_update_returns_ids[memory]</pre></summary><pre>
db = <TinyDB tables=['_default'], tables_count=1, default_table_documents_count=1, all_tables_documents_count=['_default=1']>

    def test_update_returns_ids(db: TinyDB):
        db.drop_tables()
>       assert db.insert({'int': 1, 'char': 'a'}) == 1
E       AssertionError: assert 4 == 1
E        +  where 4 = insert({'char': 'a', 'int': 1})
E        +    where insert = <TinyDB tables=['_default'], tables_count=1, default_table_documents_count=1, all_tables_documents_count=['_default=1']>.insert

tests/test_tinydb.py:233: AssertionError
</pre>
</details>
<h3 id="test_tinydbpytest_update_returns_idsjson">test_tinydb.py::test_update_returns_ids[json]</h3>
<details><summary> <pre>test_tinydb.py::test_update_returns_ids[json]</pre></summary><pre>
db = <TinyDB tables=['_default'], tables_count=1, default_table_documents_count=1, all_tables_documents_count=['_default=1']>

    def test_update_returns_ids(db: TinyDB):
        db.drop_tables()
>       assert db.insert({'int': 1, 'char': 'a'}) == 1
E       AssertionError: assert 4 == 1
E        +  where 4 = insert({'char': 'a', 'int': 1})
E        +    where insert = <TinyDB tables=['_default'], tables_count=1, default_table_documents_count=1, all_tables_documents_count=['_default=1']>.insert

tests/test_tinydb.py:233: AssertionError
</pre>
</details>
<h3 id="test_tinydbpytest_update_idsjson">test_tinydb.py::test_update_ids[json]</h3>
<details><summary> <pre>test_tinydb.py::test_update_ids[json]</pre></summary><pre>
db = <TinyDB tables=['_default'], tables_count=1, default_table_documents_count=3, all_tables_documents_count=['_default=3']>

    def test_update_ids(db: TinyDB):
        db.update({'int': 2}, doc_ids=[1, 2])

>       assert db.count(where('int') == 2) == 2
E       AssertionError: assert 0 == 2
E        +  where 0 = count(Query() == 2)
E        +    where count = <TinyDB tables=['_default'], tables_count=1, default_table_documents_count=3, all_tables_documents_count=['_default=3']>.count
E        +    and   Query() = where('int')

tests/test_tinydb.py:265: AssertionError
</pre>
</details>
<h3 id="test_tinydbpytest_upsert_by_idmemory">test_tinydb.py::test_upsert_by_id[memory]</h3>
<details><summary> <pre>test_tinydb.py::test_upsert_by_id[memory]</pre></summary><pre>
db = <TinyDB tables=['_default'], tables_count=1, default_table_documents_count=4, all_tables_documents_count=['_default=4']>

    def test_upsert_by_id(db: TinyDB):
        assert len(db) == 3

        # Single document existing
        extant_doc = Document({'char': 'v'}, doc_id=1)
        assert db.upsert(extant_doc) == [1]
        doc = db.get(where('char') == 'v')
        assert isinstance(doc, Document)
        assert doc is not None
        assert doc.doc_id == 1
        assert len(db) == 3

        # Single document missing
        missing_doc = Document({'int': 5, 'char': 'w'}, doc_id=5)
>       assert db.upsert(missing_doc) == [5]
E       AssertionError: assert [4] == [5]
E         
E         At index 0 diff: 4 != 5
E         
E         Full diff:
E           [
E         -     5,
E         ?     ^...
E         
E         ...Full output truncated (3 lines hidden), use '-vv' to show

tests/test_tinydb.py:324: AssertionError
</pre>
</details>
<h3 id="test_tinydbpytest_upsert_by_idjson">test_tinydb.py::test_upsert_by_id[json]</h3>
<details><summary> <pre>test_tinydb.py::test_upsert_by_id[json]</pre></summary><pre>
db = <TinyDB tables=['_default'], tables_count=1, default_table_documents_count=4, all_tables_documents_count=['_default=4']>

    def test_upsert_by_id(db: TinyDB):
        assert len(db) == 3

        # Single document existing
        extant_doc = Document({'char': 'v'}, doc_id=1)
>       assert db.upsert(extant_doc) == [1]
E       AssertionError: assert [4] == [1]
E         
E         At index 0 diff: 4 != 1
E         
E         Full diff:
E           [
E         -     1,
E         ?     ^...
E         
E         ...Full output truncated (3 lines hidden), use '-vv' to show

tests/test_tinydb.py:315: AssertionError
</pre>
</details>
<h3 id="test_tinydbpytest_get_idsjson">test_tinydb.py::test_get_ids[json]</h3>
<details><summary> <pre>test_tinydb.py::test_get_ids[json]</pre></summary><pre>
db = <TinyDB tables=['_default'], tables_count=1, default_table_documents_count=3, all_tables_documents_count=['_default=3']>

    def test_get_ids(db: TinyDB):
        el = db.all()[0]
>       assert db.get(doc_id=el.doc_id) == el
E       AssertionError: assert None == {'int': 1, 'char': 'a'}
E        +  where None = get(doc_id=1)
E        +    where get = <TinyDB tables=['_default'], tables_count=1, default_table_documents_count=3, all_tables_documents_count=['_default=3']>.get
E        +    and   1 = {'int': 1, 'char': 'a'}.doc_id

tests/test_tinydb.py:370: AssertionError
</pre>
</details>
<h3 id="test_tinydbpytest_get_multiple_idsjson">test_tinydb.py::test_get_multiple_ids[json]</h3>
<details><summary> <pre>test_tinydb.py::test_get_multiple_ids[json]</pre></summary><pre>
db = <TinyDB tables=['_default'], tables_count=1, default_table_documents_count=3, all_tables_documents_count=['_default=3']>

    def test_get_multiple_ids(db: TinyDB):
        el = db.all()
>       assert db.get(doc_ids=[x.doc_id for x in el]) == el
E       AssertionError: assert None == [{'int': 1, 'char': 'a'}, {'int': 1, 'char': 'b'}, {'int': 1, 'char': 'c'}]
E        +  where None = get(doc_ids=[1, 2, 3])
E        +    where get = <TinyDB tables=['_default'], tables_count=1, default_table_documents_count=3, all_tables_documents_count=['_default=3']>.get

tests/test_tinydb.py:376: AssertionError
</pre>
</details>
<h3 id="test_tinydbpytest_contains_idsjson">test_tinydb.py::test_contains_ids[json]</h3>
<details><summary> <pre>test_tinydb.py::test_contains_ids[json]</pre></summary><pre>
db = <TinyDB tables=['_default'], tables_count=1, default_table_documents_count=3, all_tables_documents_count=['_default=3']>

    def test_contains_ids(db: TinyDB):
>       assert db.contains(doc_id=1)
E       AssertionError: assert False
E        +  where False = contains(doc_id=1)
E        +    where contains = <TinyDB tables=['_default'], tables_count=1, default_table_documents_count=3, all_tables_documents_count=['_default=3']>.contains

tests/test_tinydb.py:395: AssertionError
</pre>
</details>
<h3 id="test_tinydbpytest_doc_ids_json">test_tinydb.py::test_doc_ids_json</h3>
<details><summary> <pre>test_tinydb.py::test_doc_ids_json</pre></summary><pre>
tmpdir = local('/tmp/pytest-of-root/pytest-0/test_doc_ids_json0')

    def test_doc_ids_json(tmpdir):
        """
        Regression test for issue #45
        """

        path = str(tmpdir.join('db.json'))

        with TinyDB(path) as _db:
            _db.drop_tables()
            assert _db.insert({'int': 1, 'char': 'a'}) == 1
            assert _db.insert({'int': 1, 'char': 'a'}) == 2

            _db.drop_tables()
>           assert _db.insert_multiple([{'int': 1, 'char': 'a'},
                                        {'int': 1, 'char': 'b'},
                                        {'int': 1, 'char': 'c'}]) == [1, 2, 3]
E           AssertionError: assert [3, 4, 5] == [1, 2, 3]
E             
E             At index 0 diff: 3 != 1
E             
E             Full diff:
E               [
E             -     1,
E             -     2,...
E             
E             ...Full output truncated (4 lines hidden), use '-vv' to show

tests/test_tinydb.py:511: AssertionError
</pre>
</details>
<h3 id="test_tinydbpytest_insert_invalid_dict">test_tinydb.py::test_insert_invalid_dict</h3>
<details><summary> <pre>test_tinydb.py::test_insert_invalid_dict</pre></summary><pre>
tmpdir = local('/tmp/pytest-of-root/pytest-0/test_insert_invalid_dict0')

    def test_insert_invalid_dict(tmpdir):
        path = str(tmpdir.join('db.json'))

        with TinyDB(path) as _db:
            data = [{'int': 1}, {'int': 2}]
            _db.insert_multiple(data)

            with pytest.raises(TypeError):
                _db.insert({'int': _db})  # Fails

>           assert data == _db.all()
E           AssertionError: assert [{'int': 1}, {'int': 2}] == []
E             
E             Left contains 2 more items, first extra item: {'int': 1}
E             
E             Full diff:
E             - []
E             + [
E             +     {...
E             
E             ...Full output truncated (6 lines hidden), use '-vv' to show

tests/test_tinydb.py:558: AssertionError
</pre>
</details>
<h3 id="test_utilspytest_freeze">test_utils.py::test_freeze</h3>
<details><summary> <pre>test_utils.py::test_freeze</pre></summary><pre>
def test_freeze():
        frozen = freeze([0, 1, 2, {'a': [1, 2, 3]}, {1, 2}])
        assert isinstance(frozen, tuple)
        assert isinstance(frozen[3], FrozenDict)
        assert isinstance(frozen[3]['a'], tuple)
        assert isinstance(frozen[4], frozenset)

        with pytest.raises(TypeError):
            frozen[0] = 10

        with pytest.raises(TypeError):
            frozen[3]['a'] = 10

>       with pytest.raises(TypeError):
E       Failed: DID NOT RAISE <class 'TypeError'>

tests/test_utils.py:104: Failed
</pre>
</details>

<h2 id="patch-diff">Patch diff</h2>
<div class="highlight"><pre><span></span><code><span class="gh">diff --git a/tinydb/database.py b/tinydb/database.py</span>
<span class="gh">index a9b6c89..47b3a9b 100644</span>
<span class="gd">--- a/tinydb/database.py</span>
<span class="gi">+++ b/tinydb/database.py</span>
<span class="gu">@@ -94,7 +94,13 @@ class TinyDB(TableBase):</span>
<span class="w"> </span>        :param name: The name of the table.
<span class="w"> </span>        :param kwargs: Keyword arguments to pass to the table class constructor
<span class="w"> </span>        &quot;&quot;&quot;
<span class="gd">-        pass</span>
<span class="gi">+        if name in self._tables:</span>
<span class="gi">+            return self._tables[name]</span>
<span class="gi">+</span>
<span class="gi">+        table = self.table_class(self._storage, name, **kwargs)</span>
<span class="gi">+        self._tables[name] = table</span>
<span class="gi">+</span>
<span class="gi">+        return table</span>

<span class="w"> </span>    def tables(self) -&gt; Set[str]:
<span class="w"> </span>        &quot;&quot;&quot;
<span class="gu">@@ -102,13 +108,18 @@ class TinyDB(TableBase):</span>

<span class="w"> </span>        :returns: a set of table names
<span class="w"> </span>        &quot;&quot;&quot;
<span class="gd">-        pass</span>
<span class="gi">+        data = self._storage.read()</span>
<span class="gi">+        if data is None:</span>
<span class="gi">+            return set()</span>
<span class="gi">+</span>
<span class="gi">+        return set(data.keys())</span>

<span class="w"> </span>    def drop_tables(self) -&gt; None:
<span class="w"> </span>        &quot;&quot;&quot;
<span class="w"> </span>        Drop all tables from the database. **CANNOT BE REVERSED!**
<span class="w"> </span>        &quot;&quot;&quot;
<span class="gd">-        pass</span>
<span class="gi">+        self._storage.write({})</span>
<span class="gi">+        self._tables.clear()</span>

<span class="w"> </span>    def drop_table(self, name: str) -&gt; None:
<span class="w"> </span>        &quot;&quot;&quot;
<span class="gu">@@ -116,7 +127,13 @@ class TinyDB(TableBase):</span>

<span class="w"> </span>        :param name: The name of the table to drop.
<span class="w"> </span>        &quot;&quot;&quot;
<span class="gd">-        pass</span>
<span class="gi">+        data = self._storage.read()</span>
<span class="gi">+        if data is None:</span>
<span class="gi">+            data = {}</span>
<span class="gi">+</span>
<span class="gi">+        data.pop(name, None)</span>
<span class="gi">+        self._storage.write(data)</span>
<span class="gi">+        self._tables.pop(name, None)</span>

<span class="w"> </span>    @property
<span class="w"> </span>    def storage(self) -&gt; Storage:
<span class="gu">@@ -126,7 +143,7 @@ class TinyDB(TableBase):</span>
<span class="w"> </span>        :return: This instance&#39;s storage
<span class="w"> </span>        :rtype: Storage
<span class="w"> </span>        &quot;&quot;&quot;
<span class="gd">-        pass</span>
<span class="gi">+        return self._storage</span>

<span class="w"> </span>    def close(self) -&gt; None:
<span class="w"> </span>        &quot;&quot;&quot;
<span class="gu">@@ -143,7 +160,8 @@ class TinyDB(TableBase):</span>

<span class="w"> </span>        Upon leaving this context, the ``close`` method will be called.
<span class="w"> </span>        &quot;&quot;&quot;
<span class="gd">-        pass</span>
<span class="gi">+        self._opened = False</span>
<span class="gi">+        self._storage.close()</span>

<span class="w"> </span>    def __enter__(self):
<span class="w"> </span>        &quot;&quot;&quot;
<span class="gh">diff --git a/tinydb/middlewares.py b/tinydb/middlewares.py</span>
<span class="gh">index ba9ac98..594bfda 100644</span>
<span class="gd">--- a/tinydb/middlewares.py</span>
<span class="gi">+++ b/tinydb/middlewares.py</span>
<span class="gu">@@ -82,8 +82,36 @@ class CachingMiddleware(Middleware):</span>
<span class="w"> </span>        self.cache = None
<span class="w"> </span>        self._cache_modified_count = 0

<span class="gi">+    def read(self) -&gt; Optional[dict]:</span>
<span class="gi">+        &quot;&quot;&quot;</span>
<span class="gi">+        Read data from cache or, if there is no cache data, from storage.</span>
<span class="gi">+        &quot;&quot;&quot;</span>
<span class="gi">+        if self.cache is None:</span>
<span class="gi">+            self.cache = self.storage.read()</span>
<span class="gi">+</span>
<span class="gi">+        return self.cache</span>
<span class="gi">+</span>
<span class="gi">+    def write(self, data: dict) -&gt; None:</span>
<span class="gi">+        &quot;&quot;&quot;</span>
<span class="gi">+        Write data to cache and increment the cache counter.</span>
<span class="gi">+        &quot;&quot;&quot;</span>
<span class="gi">+        self.cache = data</span>
<span class="gi">+        self._cache_modified_count += 1</span>
<span class="gi">+</span>
<span class="gi">+        if self._cache_modified_count &gt;= self.WRITE_CACHE_SIZE:</span>
<span class="gi">+            self.flush()</span>
<span class="gi">+</span>
<span class="w"> </span>    def flush(self):
<span class="w"> </span>        &quot;&quot;&quot;
<span class="w"> </span>        Flush all unwritten data to disk.
<span class="w"> </span>        &quot;&quot;&quot;
<span class="gd">-        pass</span>
\ No newline at end of file
<span class="gi">+        if self.cache is not None:</span>
<span class="gi">+            self.storage.write(self.cache)</span>
<span class="gi">+            self._cache_modified_count = 0</span>
<span class="gi">+</span>
<span class="gi">+    def close(self):</span>
<span class="gi">+        &quot;&quot;&quot;</span>
<span class="gi">+        Close the storage and write all cached data to disk.</span>
<span class="gi">+        &quot;&quot;&quot;</span>
<span class="gi">+        self.flush()</span>
<span class="gi">+        self.storage.close()</span>
\ No newline at end of file
<span class="gh">diff --git a/tinydb/operations.py b/tinydb/operations.py</span>
<span class="gh">index dcf2ff7..51c6a7f 100644</span>
<span class="gd">--- a/tinydb/operations.py</span>
<span class="gi">+++ b/tinydb/operations.py</span>
<span class="gu">@@ -12,34 +12,65 @@ def delete(field):</span>
<span class="w"> </span>    &quot;&quot;&quot;
<span class="w"> </span>    Delete a given field from the document.
<span class="w"> </span>    &quot;&quot;&quot;
<span class="gd">-    pass</span>
<span class="gi">+    def transform(doc):</span>
<span class="gi">+        if field in doc:</span>
<span class="gi">+            del doc[field]</span>
<span class="gi">+        return doc</span>
<span class="gi">+    return transform</span>

<span class="w"> </span>def add(field, n):
<span class="w"> </span>    &quot;&quot;&quot;
<span class="w"> </span>    Add ``n`` to a given field in the document.
<span class="w"> </span>    &quot;&quot;&quot;
<span class="gd">-    pass</span>
<span class="gi">+    def transform(doc):</span>
<span class="gi">+        if field not in doc:</span>
<span class="gi">+            doc[field] = n</span>
<span class="gi">+        else:</span>
<span class="gi">+            doc[field] += n</span>
<span class="gi">+        return doc</span>
<span class="gi">+    return transform</span>

<span class="w"> </span>def subtract(field, n):
<span class="w"> </span>    &quot;&quot;&quot;
<span class="w"> </span>    Subtract ``n`` to a given field in the document.
<span class="w"> </span>    &quot;&quot;&quot;
<span class="gd">-    pass</span>
<span class="gi">+    def transform(doc):</span>
<span class="gi">+        if field not in doc:</span>
<span class="gi">+            doc[field] = -n</span>
<span class="gi">+        else:</span>
<span class="gi">+            doc[field] -= n</span>
<span class="gi">+        return doc</span>
<span class="gi">+    return transform</span>

<span class="w"> </span>def set(field, val):
<span class="w"> </span>    &quot;&quot;&quot;
<span class="w"> </span>    Set a given field to ``val``.
<span class="w"> </span>    &quot;&quot;&quot;
<span class="gd">-    pass</span>
<span class="gi">+    def transform(doc):</span>
<span class="gi">+        doc[field] = val</span>
<span class="gi">+        return doc</span>
<span class="gi">+    return transform</span>

<span class="w"> </span>def increment(field):
<span class="w"> </span>    &quot;&quot;&quot;
<span class="w"> </span>    Increment a given field in the document by 1.
<span class="w"> </span>    &quot;&quot;&quot;
<span class="gd">-    pass</span>
<span class="gi">+    def transform(doc):</span>
<span class="gi">+        if field not in doc:</span>
<span class="gi">+            doc[field] = 1</span>
<span class="gi">+        else:</span>
<span class="gi">+            doc[field] += 1</span>
<span class="gi">+        return doc</span>
<span class="gi">+    return transform</span>

<span class="w"> </span>def decrement(field):
<span class="w"> </span>    &quot;&quot;&quot;
<span class="w"> </span>    Decrement a given field in the document by 1.
<span class="w"> </span>    &quot;&quot;&quot;
<span class="gd">-    pass</span>
\ No newline at end of file
<span class="gi">+    def transform(doc):</span>
<span class="gi">+        if field not in doc:</span>
<span class="gi">+            doc[field] = -1</span>
<span class="gi">+        else:</span>
<span class="gi">+            doc[field] -= 1</span>
<span class="gi">+        return doc</span>
<span class="gi">+    return transform</span>
\ No newline at end of file
<span class="gh">diff --git a/tinydb/queries.py b/tinydb/queries.py</span>
<span class="gh">index 78e7e99..d06b50e 100644</span>
<span class="gd">--- a/tinydb/queries.py</span>
<span class="gi">+++ b/tinydb/queries.py</span>
<span class="gu">@@ -92,6 +92,12 @@ class QueryInstance:</span>
<span class="w"> </span>            return self._hash == other._hash
<span class="w"> </span>        return False

<span class="gi">+    def is_cacheable(self) -&gt; bool:</span>
<span class="gi">+        &quot;&quot;&quot;</span>
<span class="gi">+        Return whether this query is cacheable.</span>
<span class="gi">+        &quot;&quot;&quot;</span>
<span class="gi">+        return self._hash is not None</span>
<span class="gi">+</span>
<span class="w"> </span>    def __and__(self, other: &#39;QueryInstance&#39;) -&gt; &#39;QueryInstance&#39;:
<span class="w"> </span>        if self.is_cacheable() and other.is_cacheable():
<span class="w"> </span>            hashval = (&#39;and&#39;, frozenset([self._hash, other._hash]))
<span class="gu">@@ -174,7 +180,30 @@ class Query(QueryInstance):</span>
<span class="w"> </span>        :param hashval: The hash of the query.
<span class="w"> </span>        :return: A :class:`~tinydb.queries.QueryInstance` object
<span class="w"> </span>        &quot;&quot;&quot;
<span class="gd">-        pass</span>
<span class="gi">+        if not self._path and not allow_empty_path:</span>
<span class="gi">+            raise ValueError(&#39;Empty query was evaluated&#39;)</span>
<span class="gi">+</span>
<span class="gi">+        def runner(value):</span>
<span class="gi">+            try:</span>
<span class="gi">+                if not self._path:</span>
<span class="gi">+                    return test(value)</span>
<span class="gi">+</span>
<span class="gi">+                for part in self._path:</span>
<span class="gi">+                    if isinstance(part, str):</span>
<span class="gi">+                        value = value[part]</span>
<span class="gi">+                    else:</span>
<span class="gi">+                        value = part(value)</span>
<span class="gi">+                return test(value)</span>
<span class="gi">+            except (KeyError, TypeError, ValueError):</span>
<span class="gi">+                return False</span>
<span class="gi">+</span>
<span class="gi">+        return QueryInstance(runner, hashval)</span>
<span class="gi">+</span>
<span class="gi">+    def is_cacheable(self) -&gt; bool:</span>
<span class="gi">+        &quot;&quot;&quot;</span>
<span class="gi">+        Return whether this query is cacheable.</span>
<span class="gi">+        &quot;&quot;&quot;</span>
<span class="gi">+        return True</span>

<span class="w"> </span>    def __eq__(self, rhs: Any):
<span class="w"> </span>        &quot;&quot;&quot;
<span class="gu">@@ -242,7 +271,7 @@ class Query(QueryInstance):</span>

<span class="w"> </span>        &gt;&gt;&gt; Query().f1.exists()
<span class="w"> </span>        &quot;&quot;&quot;
<span class="gd">-        pass</span>
<span class="gi">+        return self._generate_test(lambda _: True, (&#39;exists&#39;, self._path))</span>

<span class="w"> </span>    def matches(self, regex: str, flags: int=0) -&gt; QueryInstance:
<span class="w"> </span>        &quot;&quot;&quot;
<span class="gu">@@ -253,7 +282,9 @@ class Query(QueryInstance):</span>
<span class="w"> </span>        :param regex: The regular expression to use for matching
<span class="w"> </span>        :param flags: regex flags to pass to ``re.match``
<span class="w"> </span>        &quot;&quot;&quot;
<span class="gd">-        pass</span>
<span class="gi">+        def match(value):</span>
<span class="gi">+            return bool(re.match(regex, str(value), flags))</span>
<span class="gi">+        return self._generate_test(match, (&#39;matches&#39;, self._path, regex))</span>

<span class="w"> </span>    def search(self, regex: str, flags: int=0) -&gt; QueryInstance:
<span class="w"> </span>        &quot;&quot;&quot;
<span class="gu">@@ -265,7 +296,9 @@ class Query(QueryInstance):</span>
<span class="w"> </span>        :param regex: The regular expression to use for matching
<span class="w"> </span>        :param flags: regex flags to pass to ``re.match``
<span class="w"> </span>        &quot;&quot;&quot;
<span class="gd">-        pass</span>
<span class="gi">+        def search(value):</span>
<span class="gi">+            return bool(re.search(regex, str(value), flags))</span>
<span class="gi">+        return self._generate_test(search, (&#39;search&#39;, self._path, regex))</span>

<span class="w"> </span>    def test(self, func: Callable[[Mapping], bool], *args) -&gt; QueryInstance:
<span class="w"> </span>        &quot;&quot;&quot;
<span class="gu">@@ -287,7 +320,9 @@ class Query(QueryInstance):</span>
<span class="w"> </span>                     argument
<span class="w"> </span>        :param args: Additional arguments to pass to the test function
<span class="w"> </span>        &quot;&quot;&quot;
<span class="gd">-        pass</span>
<span class="gi">+        def run_test(value):</span>
<span class="gi">+            return func(value, *args)</span>
<span class="gi">+        return self._generate_test(run_test, (&#39;test&#39;, self._path, func, args))</span>

<span class="w"> </span>    def any(self, cond: Union[QueryInstance, List[Any]]) -&gt; QueryInstance:
<span class="w"> </span>        &quot;&quot;&quot;
<span class="gu">@@ -311,7 +346,16 @@ class Query(QueryInstance):</span>
<span class="w"> </span>                     a list of which at least one document has to be contained
<span class="w"> </span>                     in the tested document.
<span class="w"> </span>        &quot;&quot;&quot;
<span class="gd">-        pass</span>
<span class="gi">+        def contains(value):</span>
<span class="gi">+            if not isinstance(value, list):</span>
<span class="gi">+                return False</span>
<span class="gi">+</span>
<span class="gi">+            if isinstance(cond, (list, tuple)):</span>
<span class="gi">+                return any(item in cond for item in value)</span>
<span class="gi">+            else:</span>
<span class="gi">+                return any(cond(item) for item in value)</span>
<span class="gi">+</span>
<span class="gi">+        return self._generate_test(contains, (&#39;any&#39;, self._path, freeze(cond)))</span>

<span class="w"> </span>    def all(self, cond: Union[&#39;QueryInstance&#39;, List[Any]]) -&gt; QueryInstance:
<span class="w"> </span>        &quot;&quot;&quot;
<span class="gu">@@ -333,7 +377,16 @@ class Query(QueryInstance):</span>
<span class="w"> </span>        :param cond: Either a query that all documents have to match or a list
<span class="w"> </span>                     which has to be contained in the tested document.
<span class="w"> </span>        &quot;&quot;&quot;
<span class="gd">-        pass</span>
<span class="gi">+        def contains(value):</span>
<span class="gi">+            if not isinstance(value, list):</span>
<span class="gi">+                return False</span>
<span class="gi">+</span>
<span class="gi">+            if isinstance(cond, (list, tuple)):</span>
<span class="gi">+                return all(item in value for item in cond)</span>
<span class="gi">+            else:</span>
<span class="gi">+                return all(cond(item) for item in value)</span>
<span class="gi">+</span>
<span class="gi">+        return self._generate_test(contains, (&#39;all&#39;, self._path, freeze(cond)))</span>

<span class="w"> </span>    def one_of(self, items: List[Any]) -&gt; QueryInstance:
<span class="w"> </span>        &quot;&quot;&quot;
<span class="gu">@@ -343,7 +396,7 @@ class Query(QueryInstance):</span>

<span class="w"> </span>        :param items: The list of items to check with
<span class="w"> </span>        &quot;&quot;&quot;
<span class="gd">-        pass</span>
<span class="gi">+        return self._generate_test(lambda value: value in items, (&#39;one_of&#39;, self._path, freeze(items)))</span>

<span class="w"> </span>    def noop(self) -&gt; QueryInstance:
<span class="w"> </span>        &quot;&quot;&quot;
<span class="gu">@@ -351,17 +404,36 @@ class Query(QueryInstance):</span>

<span class="w"> </span>        Useful for having a base value when composing queries dynamically.
<span class="w"> </span>        &quot;&quot;&quot;
<span class="gd">-        pass</span>
<span class="gi">+        return self._generate_test(lambda _: True, (&#39;noop&#39;,), allow_empty_path=True)</span>

<span class="w"> </span>    def map(self, fn: Callable[[Any], Any]) -&gt; &#39;Query&#39;:
<span class="w"> </span>        &quot;&quot;&quot;
<span class="w"> </span>        Add a function to the query path. Similar to __getattr__ but for
<span class="w"> </span>        arbitrary functions.
<span class="w"> </span>        &quot;&quot;&quot;
<span class="gd">-        pass</span>
<span class="gi">+        query = type(self)()</span>
<span class="gi">+        query._path = self._path + (fn,)</span>
<span class="gi">+        query._hash = (&#39;path&#39;, query._path) if self.is_cacheable() else None</span>
<span class="gi">+        return query</span>
<span class="gi">+</span>
<span class="gi">+    def fragment(self, fragment: dict) -&gt; QueryInstance:</span>
<span class="gi">+        &quot;&quot;&quot;</span>
<span class="gi">+        Match a fragment of a document.</span>
<span class="gi">+</span>
<span class="gi">+        &gt;&gt;&gt; Query().fragment({&#39;foo&#39;: True})</span>
<span class="gi">+</span>
<span class="gi">+        :param fragment: The fragment to match against</span>
<span class="gi">+        &quot;&quot;&quot;</span>
<span class="gi">+        def test(value):</span>
<span class="gi">+            for key, expected in fragment.items():</span>
<span class="gi">+                if key not in value or value[key] != expected:</span>
<span class="gi">+                    return False</span>
<span class="gi">+            return True</span>
<span class="gi">+</span>
<span class="gi">+        return self._generate_test(test, (&#39;fragment&#39;, self._path, freeze(fragment)), allow_empty_path=True)</span>

<span class="w"> </span>def where(key: str) -&gt; Query:
<span class="w"> </span>    &quot;&quot;&quot;
<span class="w"> </span>    A shorthand for ``Query()[key]``
<span class="w"> </span>    &quot;&quot;&quot;
<span class="gd">-    pass</span>
\ No newline at end of file
<span class="gi">+    return Query()[key]</span>
\ No newline at end of file
<span class="gh">diff --git a/tinydb/storages.py b/tinydb/storages.py</span>
<span class="gh">index 86c0987..edd6fa2 100644</span>
<span class="gd">--- a/tinydb/storages.py</span>
<span class="gi">+++ b/tinydb/storages.py</span>
<span class="gu">@@ -17,7 +17,14 @@ def touch(path: str, create_dirs: bool):</span>
<span class="w"> </span>    :param path: The file to create.
<span class="w"> </span>    :param create_dirs: Whether to create all missing parent directories.
<span class="w"> </span>    &quot;&quot;&quot;
<span class="gd">-    pass</span>
<span class="gi">+    if create_dirs:</span>
<span class="gi">+        base_dir = os.path.dirname(path)</span>
<span class="gi">+        if base_dir:</span>
<span class="gi">+            os.makedirs(base_dir, exist_ok=True)</span>
<span class="gi">+</span>
<span class="gi">+    if not os.path.exists(path):</span>
<span class="gi">+        with open(path, &#39;a&#39;):</span>
<span class="gi">+            pass</span>

<span class="w"> </span>class Storage(ABC):
<span class="w"> </span>    &quot;&quot;&quot;
<span class="gu">@@ -83,6 +90,30 @@ class JSONStorage(Storage):</span>
<span class="w"> </span>            touch(path, create_dirs=create_dirs)
<span class="w"> </span>        self._handle = open(path, mode=self._mode, encoding=encoding)

<span class="gi">+    def read(self) -&gt; Optional[Dict[str, Dict[str, Any]]]:</span>
<span class="gi">+        # Get the file size</span>
<span class="gi">+        self._handle.seek(0, os.SEEK_END)</span>
<span class="gi">+        size = self._handle.tell()</span>
<span class="gi">+</span>
<span class="gi">+        if not size:</span>
<span class="gi">+            # File is empty</span>
<span class="gi">+            return None</span>
<span class="gi">+        else:</span>
<span class="gi">+            self._handle.seek(0)</span>
<span class="gi">+            try:</span>
<span class="gi">+                return json.load(self._handle)</span>
<span class="gi">+            except ValueError:</span>
<span class="gi">+                return None</span>
<span class="gi">+</span>
<span class="gi">+    def write(self, data: Dict[str, Dict[str, Any]]) -&gt; None:</span>
<span class="gi">+        self._handle.seek(0)</span>
<span class="gi">+        json.dump(data, self._handle, **self.kwargs)</span>
<span class="gi">+        self._handle.truncate()</span>
<span class="gi">+        self._handle.flush()</span>
<span class="gi">+</span>
<span class="gi">+    def close(self) -&gt; None:</span>
<span class="gi">+        self._handle.close()</span>
<span class="gi">+</span>
<span class="w"> </span>class MemoryStorage(Storage):
<span class="w"> </span>    &quot;&quot;&quot;
<span class="w"> </span>    Store the data as JSON in memory.
<span class="gu">@@ -93,4 +124,10 @@ class MemoryStorage(Storage):</span>
<span class="w"> </span>        Create a new instance.
<span class="w"> </span>        &quot;&quot;&quot;
<span class="w"> </span>        super().__init__()
<span class="gd">-        self.memory = None</span>
\ No newline at end of file
<span class="gi">+        self.memory = None</span>
<span class="gi">+</span>
<span class="gi">+    def read(self) -&gt; Optional[Dict[str, Dict[str, Any]]]:</span>
<span class="gi">+        return self.memory</span>
<span class="gi">+</span>
<span class="gi">+    def write(self, data: Dict[str, Dict[str, Any]]) -&gt; None:</span>
<span class="gi">+        self.memory = data</span>
\ No newline at end of file
<span class="gh">diff --git a/tinydb/table.py b/tinydb/table.py</span>
<span class="gh">index 5f0a160..d6fa1f0 100644</span>
<span class="gd">--- a/tinydb/table.py</span>
<span class="gi">+++ b/tinydb/table.py</span>
<span class="gu">@@ -80,14 +80,14 @@ class Table:</span>
<span class="w"> </span>        &quot;&quot;&quot;
<span class="w"> </span>        Get the table name.
<span class="w"> </span>        &quot;&quot;&quot;
<span class="gd">-        pass</span>
<span class="gi">+        return self._name</span>

<span class="w"> </span>    @property
<span class="w"> </span>    def storage(self) -&gt; Storage:
<span class="w"> </span>        &quot;&quot;&quot;
<span class="w"> </span>        Get the table storage instance.
<span class="w"> </span>        &quot;&quot;&quot;
<span class="gd">-        pass</span>
<span class="gi">+        return self._storage</span>

<span class="w"> </span>    def insert(self, document: Mapping) -&gt; int:
<span class="w"> </span>        &quot;&quot;&quot;
<span class="gu">@@ -96,7 +96,26 @@ class Table:</span>
<span class="w"> </span>        :param document: the document to insert
<span class="w"> </span>        :returns: the inserted document&#39;s ID
<span class="w"> </span>        &quot;&quot;&quot;
<span class="gd">-        pass</span>
<span class="gi">+        if not isinstance(document, Mapping):</span>
<span class="gi">+            raise ValueError(&#39;Document is not a Mapping&#39;)</span>
<span class="gi">+</span>
<span class="gi">+        if isinstance(document, Document):</span>
<span class="gi">+            doc_id = document.doc_id</span>
<span class="gi">+            document = dict(document)</span>
<span class="gi">+            if doc_id in self._read_table():</span>
<span class="gi">+                raise ValueError(&#39;Document ID already exists&#39;)</span>
<span class="gi">+        else:</span>
<span class="gi">+            doc_id = self._get_next_id()</span>
<span class="gi">+</span>
<span class="gi">+        data = dict(document)</span>
<span class="gi">+</span>
<span class="gi">+        def updater(table: Dict[int, Mapping]):</span>
<span class="gi">+            table[doc_id] = data</span>
<span class="gi">+</span>
<span class="gi">+        self._update_table(updater)</span>
<span class="gi">+        self._query_cache.clear()</span>
<span class="gi">+</span>
<span class="gi">+        return doc_id</span>

<span class="w"> </span>    def insert_multiple(self, documents: Iterable[Mapping]) -&gt; List[int]:
<span class="w"> </span>        &quot;&quot;&quot;
<span class="gu">@@ -105,7 +124,36 @@ class Table:</span>
<span class="w"> </span>        :param documents: an Iterable of documents to insert
<span class="w"> </span>        :returns: a list containing the inserted documents&#39; IDs
<span class="w"> </span>        &quot;&quot;&quot;
<span class="gd">-        pass</span>
<span class="gi">+        doc_ids = []</span>
<span class="gi">+        data = []</span>
<span class="gi">+        documents = list(documents)</span>
<span class="gi">+</span>
<span class="gi">+        if len(documents) == 1 and not isinstance(documents[0], Mapping):</span>
<span class="gi">+            raise ValueError(&#39;Document is not a Mapping&#39;)</span>
<span class="gi">+</span>
<span class="gi">+        table = self._read_table()</span>
<span class="gi">+        for doc in documents:</span>
<span class="gi">+            if not isinstance(doc, Mapping):</span>
<span class="gi">+                raise ValueError(&#39;Document is not a Mapping&#39;)</span>
<span class="gi">+</span>
<span class="gi">+            if isinstance(doc, Document):</span>
<span class="gi">+                doc_id = doc.doc_id</span>
<span class="gi">+                doc = dict(doc)</span>
<span class="gi">+                if doc_id in table:</span>
<span class="gi">+                    raise ValueError(&#39;Document ID already exists&#39;)</span>
<span class="gi">+            else:</span>
<span class="gi">+                doc_id = self._get_next_id()</span>
<span class="gi">+            doc_ids.append(doc_id)</span>
<span class="gi">+            data.append((doc_id, dict(doc)))</span>
<span class="gi">+</span>
<span class="gi">+        def updater(table: Dict[int, Mapping]):</span>
<span class="gi">+            for doc_id, doc in data:</span>
<span class="gi">+                table[doc_id] = doc</span>
<span class="gi">+</span>
<span class="gi">+        self._update_table(updater)</span>
<span class="gi">+        self._query_cache.clear()</span>
<span class="gi">+</span>
<span class="gi">+        return doc_ids</span>

<span class="w"> </span>    def all(self) -&gt; List[Document]:
<span class="w"> </span>        &quot;&quot;&quot;
<span class="gu">@@ -113,7 +161,9 @@ class Table:</span>

<span class="w"> </span>        :returns: a list with all documents.
<span class="w"> </span>        &quot;&quot;&quot;
<span class="gd">-        pass</span>
<span class="gi">+        table = self._read_table()</span>
<span class="gi">+        return [self.document_class(doc, self.document_id_class(doc_id))</span>
<span class="gi">+                for doc_id, doc in table.items()]</span>

<span class="w"> </span>    def search(self, cond: QueryLike) -&gt; List[Document]:
<span class="w"> </span>        &quot;&quot;&quot;
<span class="gu">@@ -122,7 +172,16 @@ class Table:</span>
<span class="w"> </span>        :param cond: the condition to check against
<span class="w"> </span>        :returns: list of matching documents
<span class="w"> </span>        &quot;&quot;&quot;
<span class="gd">-        pass</span>
<span class="gi">+        if hasattr(cond, &#39;is_cacheable&#39;) and not cond.is_cacheable():</span>
<span class="gi">+            return [doc for doc in self.all() if cond(doc)]</span>
<span class="gi">+</span>
<span class="gi">+        if cond in self._query_cache:</span>
<span class="gi">+            return list(self._query_cache[cond])</span>
<span class="gi">+</span>
<span class="gi">+        docs = [doc for doc in self.all() if cond(doc)]</span>
<span class="gi">+        self._query_cache[cond] = docs</span>
<span class="gi">+</span>
<span class="gi">+        return list(docs)</span>

<span class="w"> </span>    def get(self, cond: Optional[QueryLike]=None, doc_id: Optional[int]=None, doc_ids: Optional[List]=None) -&gt; Optional[Union[Document, List[Document]]]:
<span class="w"> </span>        &quot;&quot;&quot;
<span class="gu">@@ -138,7 +197,29 @@ class Table:</span>

<span class="w"> </span>        :returns: the document(s) or ``None``
<span class="w"> </span>        &quot;&quot;&quot;
<span class="gd">-        pass</span>
<span class="gi">+        if cond is None and doc_id is None and doc_ids is None:</span>
<span class="gi">+            raise RuntimeError(&#39;Cannot get documents without a condition or document ID&#39;)</span>
<span class="gi">+</span>
<span class="gi">+        if doc_id is not None:</span>
<span class="gi">+            table = self._read_table()</span>
<span class="gi">+            if doc_id in table:</span>
<span class="gi">+                return self.document_class(table[doc_id], self.document_id_class(doc_id))</span>
<span class="gi">+            return None</span>
<span class="gi">+</span>
<span class="gi">+        if doc_ids is not None:</span>
<span class="gi">+            docs = []</span>
<span class="gi">+            table = self._read_table()</span>
<span class="gi">+            for did in doc_ids:</span>
<span class="gi">+                if did in table:</span>
<span class="gi">+                    docs.append(self.document_class(table[did], self.document_id_class(did)))</span>
<span class="gi">+            return docs if docs else None</span>
<span class="gi">+</span>
<span class="gi">+        if cond is not None:</span>
<span class="gi">+            docs = self.search(cond)</span>
<span class="gi">+            if docs:</span>
<span class="gi">+                return docs[0]</span>
<span class="gi">+</span>
<span class="gi">+        return None</span>

<span class="w"> </span>    def contains(self, cond: Optional[QueryLike]=None, doc_id: Optional[int]=None) -&gt; bool:
<span class="w"> </span>        &quot;&quot;&quot;
<span class="gu">@@ -150,7 +231,13 @@ class Table:</span>
<span class="w"> </span>        :param cond: the condition use
<span class="w"> </span>        :param doc_id: the document ID to look for
<span class="w"> </span>        &quot;&quot;&quot;
<span class="gd">-        pass</span>
<span class="gi">+        if cond is None and doc_id is None:</span>
<span class="gi">+            raise RuntimeError(&#39;Cannot check for documents without a condition or document ID&#39;)</span>
<span class="gi">+</span>
<span class="gi">+        if doc_id is not None:</span>
<span class="gi">+            return doc_id in self._read_table()</span>
<span class="gi">+</span>
<span class="gi">+        return bool(self.get(cond))</span>

<span class="w"> </span>    def update(self, fields: Union[Mapping, Callable[[Mapping], None]], cond: Optional[QueryLike]=None, doc_ids: Optional[Iterable[int]]=None) -&gt; List[int]:
<span class="w"> </span>        &quot;&quot;&quot;
<span class="gu">@@ -162,7 +249,39 @@ class Table:</span>
<span class="w"> </span>        :param doc_ids: a list of document IDs
<span class="w"> </span>        :returns: a list containing the updated document&#39;s ID
<span class="w"> </span>        &quot;&quot;&quot;
<span class="gd">-        pass</span>
<span class="gi">+        if doc_ids is not None:</span>
<span class="gi">+            doc_ids = list(doc_ids)</span>
<span class="gi">+</span>
<span class="gi">+        def updater(table: Dict[int, Mapping]):</span>
<span class="gi">+            updated_ids = []</span>
<span class="gi">+</span>
<span class="gi">+            if doc_ids is not None:</span>
<span class="gi">+                for doc_id in doc_ids:</span>
<span class="gi">+                    if doc_id in table:</span>
<span class="gi">+                        updated_ids.append(doc_id)</span>
<span class="gi">+                        if callable(fields):</span>
<span class="gi">+                            doc = table[doc_id].copy()</span>
<span class="gi">+                            fields(doc)</span>
<span class="gi">+                            table[doc_id] = doc</span>
<span class="gi">+                        else:</span>
<span class="gi">+                            table[doc_id].update(fields)</span>
<span class="gi">+            else:</span>
<span class="gi">+                for doc_id, doc in list(table.items()):</span>
<span class="gi">+                    if cond is None or cond(doc):</span>
<span class="gi">+                        updated_ids.append(doc_id)</span>
<span class="gi">+                        if callable(fields):</span>
<span class="gi">+                            doc = doc.copy()</span>
<span class="gi">+                            fields(doc)</span>
<span class="gi">+                            table[doc_id] = doc</span>
<span class="gi">+                        else:</span>
<span class="gi">+                            table[doc_id].update(fields)</span>
<span class="gi">+</span>
<span class="gi">+            return updated_ids</span>
<span class="gi">+</span>
<span class="gi">+        updated_ids = self._update_table(updater)</span>
<span class="gi">+        self._query_cache.clear()</span>
<span class="gi">+</span>
<span class="gi">+        return updated_ids</span>

<span class="w"> </span>    def update_multiple(self, updates: Iterable[Tuple[Union[Mapping, Callable[[Mapping], None]], QueryLike]]) -&gt; List[int]:
<span class="w"> </span>        &quot;&quot;&quot;
<span class="gu">@@ -170,7 +289,10 @@ class Table:</span>

<span class="w"> </span>        :returns: a list containing the updated document&#39;s ID
<span class="w"> </span>        &quot;&quot;&quot;
<span class="gd">-        pass</span>
<span class="gi">+        updated_ids = []</span>
<span class="gi">+        for fields, cond in updates:</span>
<span class="gi">+            updated_ids.extend(self.update(fields, cond))</span>
<span class="gi">+        return updated_ids</span>

<span class="w"> </span>    def upsert(self, document: Mapping, cond: Optional[QueryLike]=None) -&gt; List[int]:
<span class="w"> </span>        &quot;&quot;&quot;
<span class="gu">@@ -185,7 +307,20 @@ class Table:</span>
<span class="w"> </span>        Document with a doc_id
<span class="w"> </span>        :returns: a list containing the updated documents&#39; IDs
<span class="w"> </span>        &quot;&quot;&quot;
<span class="gd">-        pass</span>
<span class="gi">+        if isinstance(document, Document):</span>
<span class="gi">+            doc_id = document.doc_id</span>
<span class="gi">+            updated = self.update(document, doc_ids=[doc_id])</span>
<span class="gi">+            if updated:</span>
<span class="gi">+                return updated</span>
<span class="gi">+</span>
<span class="gi">+            document = dict(document)</span>
<span class="gi">+            return [self.insert(document)]</span>
<span class="gi">+</span>
<span class="gi">+        updated = self.update(document, cond)</span>
<span class="gi">+        if updated:</span>
<span class="gi">+            return updated</span>
<span class="gi">+</span>
<span class="gi">+        return [self.insert(document)]</span>

<span class="w"> </span>    def remove(self, cond: Optional[QueryLike]=None, doc_ids: Optional[Iterable[int]]=None) -&gt; List[int]:
<span class="w"> </span>        &quot;&quot;&quot;
<span class="gu">@@ -195,13 +330,44 @@ class Table:</span>
<span class="w"> </span>        :param doc_ids: a list of document IDs
<span class="w"> </span>        :returns: a list containing the removed documents&#39; ID
<span class="w"> </span>        &quot;&quot;&quot;
<span class="gd">-        pass</span>
<span class="gi">+        if cond is None and doc_ids is None:</span>
<span class="gi">+            raise RuntimeError(&#39;Cannot remove documents without a condition or document IDs&#39;)</span>
<span class="gi">+</span>
<span class="gi">+        if doc_ids is not None:</span>
<span class="gi">+            doc_ids = list(doc_ids)</span>
<span class="gi">+</span>
<span class="gi">+        def updater(table: Dict[int, Mapping]):</span>
<span class="gi">+            removed = []</span>
<span class="gi">+</span>
<span class="gi">+            if doc_ids is not None:</span>
<span class="gi">+                for doc_id in doc_ids:</span>
<span class="gi">+                    if doc_id in table:</span>
<span class="gi">+                        removed.append(doc_id)</span>
<span class="gi">+                        del table[doc_id]</span>
<span class="gi">+            else:</span>
<span class="gi">+                for doc_id, doc in list(table.items()):</span>
<span class="gi">+                    if cond(doc):</span>
<span class="gi">+                        removed.append(doc_id)</span>
<span class="gi">+                        del table[doc_id]</span>
<span class="gi">+</span>
<span class="gi">+            return removed</span>
<span class="gi">+</span>
<span class="gi">+        removed_ids = self._update_table(updater)</span>
<span class="gi">+        self._query_cache.clear()</span>
<span class="gi">+</span>
<span class="gi">+        return removed_ids</span>

<span class="w"> </span>    def truncate(self) -&gt; None:
<span class="w"> </span>        &quot;&quot;&quot;
<span class="w"> </span>        Truncate the table by removing all documents.
<span class="w"> </span>        &quot;&quot;&quot;
<span class="gd">-        pass</span>
<span class="gi">+        def updater(table: Dict[int, Mapping]):</span>
<span class="gi">+            table.clear()</span>
<span class="gi">+            return []</span>
<span class="gi">+</span>
<span class="gi">+        self._update_table(updater)</span>
<span class="gi">+        self._query_cache.clear()</span>
<span class="gi">+        self._next_id = 1</span>

<span class="w"> </span>    def count(self, cond: QueryLike) -&gt; int:
<span class="w"> </span>        &quot;&quot;&quot;
<span class="gu">@@ -209,13 +375,13 @@ class Table:</span>

<span class="w"> </span>        :param cond: the condition use
<span class="w"> </span>        &quot;&quot;&quot;
<span class="gd">-        pass</span>
<span class="gi">+        return len(self.search(cond))</span>

<span class="w"> </span>    def clear_cache(self) -&gt; None:
<span class="w"> </span>        &quot;&quot;&quot;
<span class="w"> </span>        Clear the query cache.
<span class="w"> </span>        &quot;&quot;&quot;
<span class="gd">-        pass</span>
<span class="gi">+        self._query_cache.clear()</span>

<span class="w"> </span>    def __len__(self):
<span class="w"> </span>        &quot;&quot;&quot;
<span class="gu">@@ -236,9 +402,18 @@ class Table:</span>
<span class="w"> </span>        &quot;&quot;&quot;
<span class="w"> </span>        Return the ID for a newly inserted document.
<span class="w"> </span>        &quot;&quot;&quot;
<span class="gd">-        pass</span>
<span class="gi">+        if self._next_id is None:</span>
<span class="gi">+            table = self._read_table()</span>
<span class="gi">+            if table:</span>
<span class="gi">+                self._next_id = max(int(key) for key in table.keys()) + 1</span>
<span class="gi">+            else:</span>
<span class="gi">+                self._next_id = 1</span>
<span class="gi">+</span>
<span class="gi">+        next_id = self._next_id</span>
<span class="gi">+        self._next_id = next_id + 1</span>
<span class="gi">+        return next_id</span>

<span class="gd">-    def _read_table(self) -&gt; Dict[str, Mapping]:</span>
<span class="gi">+    def _read_table(self) -&gt; Dict[int, Mapping]:</span>
<span class="w"> </span>        &quot;&quot;&quot;
<span class="w"> </span>        Read the table data from the underlying storage.

<span class="gu">@@ -246,7 +421,16 @@ class Table:</span>
<span class="w"> </span>        we may not want to convert *all* documents when returning
<span class="w"> </span>        only one document for example.
<span class="w"> </span>        &quot;&quot;&quot;
<span class="gd">-        pass</span>
<span class="gi">+        raw_data = self._storage.read()</span>
<span class="gi">+        if raw_data is None:</span>
<span class="gi">+            raw_data = {}</span>
<span class="gi">+</span>
<span class="gi">+        table = raw_data.get(self._name, {})</span>
<span class="gi">+        if not isinstance(table, dict):</span>
<span class="gi">+            table = {}</span>
<span class="gi">+            raw_data[self._name] = table</span>
<span class="gi">+</span>
<span class="gi">+        return table</span>

<span class="w"> </span>    def _update_table(self, updater: Callable[[Dict[int, Mapping]], None]):
<span class="w"> </span>        &quot;&quot;&quot;
<span class="gu">@@ -261,4 +445,13 @@ class Table:</span>
<span class="w"> </span>        As a further optimization, we don&#39;t convert the documents into the
<span class="w"> </span>        document class, as the table data will *not* be returned to the user.
<span class="w"> </span>        &quot;&quot;&quot;
<span class="gd">-        pass</span>
\ No newline at end of file
<span class="gi">+        raw_data = self._storage.read()</span>
<span class="gi">+        if raw_data is None:</span>
<span class="gi">+            raw_data = {}</span>
<span class="gi">+</span>
<span class="gi">+        table = raw_data.get(self._name, {})</span>
<span class="gi">+        result = updater(table)</span>
<span class="gi">+        raw_data[self._name] = table</span>
<span class="gi">+        self._storage.write(raw_data)</span>
<span class="gi">+</span>
<span class="gi">+        return result</span>
\ No newline at end of file
<span class="gh">diff --git a/tinydb/utils.py b/tinydb/utils.py</span>
<span class="gh">index 161c511..07c2a33 100644</span>
<span class="gd">--- a/tinydb/utils.py</span>
<span class="gi">+++ b/tinydb/utils.py</span>
<span class="gu">@@ -22,7 +22,7 @@ def with_typehint(baseclass: Type[T]):</span>
<span class="w"> </span>    MyPy does not. For that reason TinyDB has a MyPy plugin in
<span class="w"> </span>    ``mypy_plugin.py`` that adds support for this pattern.
<span class="w"> </span>    &quot;&quot;&quot;
<span class="gd">-    pass</span>
<span class="gi">+    return baseclass</span>

<span class="w"> </span>class LRUCache(abc.MutableMapping, Generic[K, V]):
<span class="w"> </span>    &quot;&quot;&quot;
<span class="gu">@@ -43,26 +43,50 @@ class LRUCache(abc.MutableMapping, Generic[K, V]):</span>
<span class="w"> </span>        self.cache: OrderedDict[K, V] = OrderedDict()

<span class="w"> </span>    def __len__(self) -&gt; int:
<span class="gd">-        return self.length</span>
<span class="gi">+        return len(self.cache)</span>

<span class="w"> </span>    def __contains__(self, key: object) -&gt; bool:
<span class="w"> </span>        return key in self.cache

<span class="w"> </span>    def __setitem__(self, key: K, value: V) -&gt; None:
<span class="gd">-        self.set(key, value)</span>
<span class="gi">+        if key in self.cache:</span>
<span class="gi">+            del self.cache[key]</span>
<span class="gi">+        self.cache[key] = value</span>
<span class="gi">+        if self.capacity is not None and len(self.cache) &gt; self.capacity:</span>
<span class="gi">+            self.cache.popitem(last=False)  # Remove first item (least recently used)</span>

<span class="w"> </span>    def __delitem__(self, key: K) -&gt; None:
<span class="w"> </span>        del self.cache[key]

<span class="w"> </span>    def __getitem__(self, key) -&gt; V:
<span class="gd">-        value = self.get(key)</span>
<span class="gd">-        if value is None:</span>
<span class="gi">+        if key not in self.cache:</span>
<span class="w"> </span>            raise KeyError(key)
<span class="gi">+        value = self.cache.pop(key)</span>
<span class="gi">+        self.cache[key] = value  # Move to end</span>
<span class="w"> </span>        return value

<span class="w"> </span>    def __iter__(self) -&gt; Iterator[K]:
<span class="w"> </span>        return iter(self.cache)

<span class="gi">+    def get(self, key: K, default: Optional[V] = None) -&gt; Optional[V]:</span>
<span class="gi">+        try:</span>
<span class="gi">+            return self[key]</span>
<span class="gi">+        except KeyError:</span>
<span class="gi">+            return default</span>
<span class="gi">+</span>
<span class="gi">+    def clear(self) -&gt; None:</span>
<span class="gi">+        self.cache.clear()</span>
<span class="gi">+</span>
<span class="gi">+    @property</span>
<span class="gi">+    def lru(self) -&gt; list:</span>
<span class="gi">+        return list(self.cache.keys())</span>
<span class="gi">+</span>
<span class="gi">+def _immutable(*args, **kw):</span>
<span class="gi">+    &quot;&quot;&quot;</span>
<span class="gi">+    Function that raises a TypeError when trying to modify an immutable object.</span>
<span class="gi">+    &quot;&quot;&quot;</span>
<span class="gi">+    raise TypeError(&#39;object is immutable&#39;)</span>
<span class="gi">+</span>
<span class="w"> </span>class FrozenDict(dict):
<span class="w"> </span>    &quot;&quot;&quot;
<span class="w"> </span>    An immutable dictionary.
<span class="gu">@@ -84,4 +108,10 @@ def freeze(obj):</span>
<span class="w"> </span>    &quot;&quot;&quot;
<span class="w"> </span>    Freeze an object by making it immutable and thus hashable.
<span class="w"> </span>    &quot;&quot;&quot;
<span class="gd">-    pass</span>
\ No newline at end of file
<span class="gi">+    if isinstance(obj, dict):</span>
<span class="gi">+        return FrozenDict((k, freeze(v)) for k, v in obj.items())</span>
<span class="gi">+    elif isinstance(obj, (list, tuple)):</span>
<span class="gi">+        return tuple(freeze(el) for el in obj)</span>
<span class="gi">+    elif isinstance(obj, set):</span>
<span class="gi">+        return frozenset(freeze(el) for el in obj)</span>
<span class="gi">+    return obj</span>
\ No newline at end of file
</code></pre></div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.6ce7567c.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.d6f25eb3.min.js"></script>
      
        <script src="https://unpkg.com/tablesort@5.3.0/dist/tablesort.min.js"></script>
      
        <script src="../javascripts/tablesort.js"></script>
      
    
  </body>
</html>